<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>Age-Size IPMs</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Age-Size IPMs</h1>


<div id="TOC">
<ul>
<li><a href="#introduction-to-age-times-size-classified-models">Introduction to
age <span class="math inline">\(\times\)</span> size classified
models</a></li>
<li><a href="#mathematical-overview">Mathematical overview</a></li>
<li><a href="#model-parameterization">Model parameterization</a></li>
<li><a href="#further-analyses">Further analyses</a></li>
</ul>
</div>

<div id="introduction-to-age-times-size-classified-models" class="section level2">
<h2>Introduction to age <span class="math inline">\(\times\)</span> size
classified models</h2>
<p>Many species exhibit age-dependent demography in addition to some
other continuous measures of size. Long term, age classified data sets
aren’t nearly as common as non-age classified data sets, but can be
exceptionally insightful when available. <code>ipmr</code> includes some
methods to deal with specifying them.</p>
<p>While we may be tempted to think of age as a continuous quantity, it
must be a discrete state in a discrete time model. This makes the age
<span class="math inline">\(\times\)</span> size IPM a special case of
the general IPM. This also uses the parameter index syntax, and it is
largely the same as for other, non-age structured IPMs, but includes a
couple extra bits that must be specified.</p>
<p>The rest of this vignette assumes you are familiar with the suffix
notation that <code>ipmr</code> uses. If you haven’t already covered
this, it would be best to read at least the <a href="https://padrinoDB.github.io/ipmr/articles/ipmr-introduction.html">Intro</a>
and <a href="https://padrinoDB.github.io/ipmr/articles/general-ipms.html">General
IPM</a> vignettes before continuing. We’ll model Soay sheep (<em>Ovis
aries</em>) from St. Kilda using parameters from Chapter 6 of Ellner,
Childs, &amp; Rees (2016).</p>
</div>
<div id="mathematical-overview" class="section level2">
<h2>Mathematical overview</h2>
<p>The deterministic form of an age <span class="math inline">\(\times\)</span> size model is generally:</p>
<ol style="list-style-type: decimal">
<li><span class="math inline">\(n_0(z&#39;,t+1) = \sum\limits_{a=0}^M
\int_L^UF_a(z&#39;,z)n_a(z,t)dz\)</span></li>
</ol>
<p>and</p>
<ol start="2" style="list-style-type: decimal">
<li><span class="math inline">\(n_a(z&#39;,t+1) = \int_L^U
P_{a-1}(z&#39;,z)n_{a-1}(z,t)dz\)</span> for <span class="math inline">\(a = 1,2,...,M\)</span></li>
</ol>
<p><span class="math inline">\(M\)</span> indicates the maximum age
beyond which we assume no individuals can survive. If we aren’t
comfortable with that assumption, then we can add a third equation to
specify the number of individuals in the “<span class="math inline">\(M+1\)</span> or older” age class:</p>
<ol start="3" style="list-style-type: decimal">
<li><span class="math inline">\(n_{M+1}(z&#39;,t+1) =
\int_L^U[P_M(z&#39;,z)n_M(z,t) +
P_{M+1}(z&#39;,z)n_{M+1}(z,t)]dz\)</span></li>
</ol>
<p>If we do this, then the upper limit in the sum of Eq 1 must be
modified to include <span class="math inline">\(M+1\)</span>. The Soay
sheep model we are about to work on includes this <span class="math inline">\(M+1\)</span> age group.</p>
<p>The sub-kernels in this model are formed using regression models
for:</p>
<ul>
<li><p>survival (<code>s_age</code>/<span class="math inline">\(s(z,a)\)</span>)</p></li>
<li><p>growth (<code>g_age</code>/<span class="math inline">\(G(z&#39;,z,a)\)</span>)</p></li>
<li><p>probability of adults reproducing (<code>pb_age</code>/<span class="math inline">\(p_b(z,a)\)</span>)</p></li>
<li><p>probability that a recruit survives to the first census
(<code>pr_age</code>/<span class="math inline">\(p_r(a)\)</span>)</p></li>
<li><p>recruit size distribution (<code>rcsz</code>/<span class="math inline">\(C_d(z&#39;,z)\)</span>). The recruit size
distribution has a maternal effect of parental weight on recruit
weight.</p></li>
</ul>
<p>The sub-kernels have the following form:</p>
<ol start="4" style="list-style-type: decimal">
<li><p><span class="math inline">\(P_a(z&#39;, z, a) = s(z, a) *
G(z&#39;, z, a)\)</span></p></li>
<li><p><span class="math inline">\(F_a(z&#39;, z, a) = s(z, a) * p_b(z,
a) * p_r(a) * C_d(z&#39;, z) * 0.5\)</span></p>
<ul>
<li><p><span class="math inline">\(F_0 \equiv 0\)</span> so that age-0
recruits cannot reproduce.</p></li>
<li><p>This model only tracks females. Assuming an equal sex ratio, we
multiply the fecundity kernels by 0.5. We could change the weighting
based on observed data.</p></li>
</ul></li>
</ol>
<p>The vital rates are as follows:</p>
<ol start="6" style="list-style-type: decimal">
<li><p>Survival (<code>s_age</code>/<span class="math inline">\(s(z,a)\)</span>): A logistic regression with size
and age as fixed effects.</p>
<ul>
<li><p>Example code:
<code>glm(surv ~ size + age, data = survival_data, family = binomial())</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Logit(s(z,a)) =
\alpha_s + \beta_s^z * z + \beta_s^a *age\)</span></p></li>
</ul></li>
<li><p>Growth (<code>g_age</code>/<span class="math inline">\(G(z&#39;,z,a)\)</span>): A linear model with size
and age as fixed effects. <span class="math inline">\(f_G\)</span>
denotes a normal probability density function.</p>
<ul>
<li><p>Example code:
<code>lm(size_next ~ size + age, data = growth data)</code></p></li>
<li><p>Mathematical form:</p>
<ul>
<li><p><span class="math inline">\(G(z&#39;,z,a) = f_G(\mu_G(z, a),
\sigma_G)\)</span></p></li>
<li><p><span class="math inline">\(\mu_G(z, a) = \alpha_G + \beta_G^z *
z + \beta_G^a * age\)</span></p></li>
</ul></li>
</ul></li>
<li><p>Probability of reproduction (<code>pb_age</code>/<span class="math inline">\(p_b(z,a)\)</span>): A logistic regression with
size and age as fixed effects.</p>
<ul>
<li><p>Example code:
<code>glm(repr ~ size + age, data = repr_data, family = binomial())</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Logit(p_b(z,a)) =
\alpha_{p_b} + \beta_{p_b}^z * z + \beta_{p_b}^a *
age)\)</span></p></li>
</ul></li>
<li><p>Probability of recruitment (<code>pr_age</code>/<span class="math inline">\(p_r(a)\)</span>): A logistic regression with age
as a fixed effect.</p>
<ul>
<li><p>Example code:
<code>glm(recr ~ age, data = recr_data, family = binomial())</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Logit(p_r(a)) =
\alpha_{p_r} + \beta_{p_r}^a * age\)</span></p></li>
</ul></li>
<li><p>Recruit size distribution (<code>rcsz</code>/<span class="math inline">\(C_d(z&#39;,z)\)</span>): A linear model with
parent size as a fixed effect. <span class="math inline">\(f_{C_d}\)</span> denotes a normal probability
density function.</p>
<ul>
<li><p>Example code:
<code>lm(rcsz ~ size, data = rcsz_data)</code></p></li>
<li><p>Mathematical form:</p>
<ul>
<li><p><span class="math inline">\(C_d(z&#39;,z) = f_{C_d}(\mu_{C_d}(z),
\sigma_{C_d})\)</span></p></li>
<li><p><span class="math inline">\(\mu_{C_d}(z) = \alpha_{C_d} +
\beta_{C_d}^z * z\)</span></p></li>
</ul></li>
</ul></li>
</ol>
</div>
<div id="model-parameterization" class="section level2">
<h2>Model parameterization</h2>
<p>This example directly reproduces the model found in Ellner, Rees
&amp; Childs (2016), chapter 6.2. The code that implements that version
can be found <a href="https://github.com/ipmbook/first-edition/tree/master/Rcode/c6">here</a>.
This example will skip the IBM simulation and model fitting and just
focus on the new syntax (<code>ipmr</code> doesn’t .</p>
<p>First, we set up our parameter list and define a couple functions to
help out. The <code>f_fun</code> is used to wrap <code>formula</code>
argument in <code>&quot;F_age&quot;</code> kernel so that we can concisely express
that age-0 individuals do not reproduce. Note that it is not possible to
use an <code>ifelse()</code> statement instead, because <code>age</code>
will be a single number, and <code>ifelse()</code> always returns a
value that is the same length as its input (and we want the return value
to be a <span class="math inline">\(100\times100\)</span> matrix).</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ipmr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a>param_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">surv_int =</span> <span class="sc">-</span><span class="dv">17</span>, </span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">surv_z =</span> <span class="fl">6.68</span>,</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">surv_a =</span> <span class="sc">-</span><span class="fl">0.334</span>, </span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">grow_int =</span> <span class="fl">1.27</span>, </span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">grow_z =</span> <span class="fl">0.612</span>, </span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">grow_a =</span> <span class="sc">-</span><span class="fl">0.00724</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">grow_sd =</span> <span class="fl">0.0787</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">repr_int =</span> <span class="sc">-</span><span class="fl">7.88</span>, </span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">repr_z =</span> <span class="fl">3.11</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">repr_a =</span> <span class="sc">-</span><span class="fl">0.078</span>, </span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">recr_int =</span> <span class="fl">1.11</span>, </span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">recr_a =</span> <span class="fl">0.184</span>, </span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">rcsz_int =</span> <span class="fl">0.362</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">rcsz_z =</span> <span class="fl">0.709</span>, </span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">rcsz_sd =</span> <span class="fl">0.159</span></span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-21"><a href="#cb1-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-22"><a href="#cb1-22" aria-hidden="true" tabindex="-1"></a>inv_logit <span class="ot">&lt;-</span> <span class="cf">function</span>(x) {</span>
<span id="cb1-23"><a href="#cb1-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-24"><a href="#cb1-24" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>( <span class="dv">1</span> <span class="sc">/</span> (<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>x)) )</span>
<span id="cb1-25"><a href="#cb1-25" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb1-26"><a href="#cb1-26" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-27"><a href="#cb1-27" aria-hidden="true" tabindex="-1"></a>f_fun <span class="ot">&lt;-</span> <span class="cf">function</span>(age, s_age, pb_age, pr_age, recr) {</span>
<span id="cb1-28"><a href="#cb1-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-29"><a href="#cb1-29" aria-hidden="true" tabindex="-1"></a>  <span class="cf">if</span>(age <span class="sc">==</span> <span class="dv">0</span>) <span class="fu">return</span>(<span class="dv">0</span>)</span>
<span id="cb1-30"><a href="#cb1-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-31"><a href="#cb1-31" aria-hidden="true" tabindex="-1"></a>  s_age <span class="sc">*</span> pb_age <span class="sc">*</span> pr_age <span class="sc">*</span> recr <span class="sc">*</span> <span class="fl">0.5</span></span>
<span id="cb1-32"><a href="#cb1-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-33"><a href="#cb1-33" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Next, we begin to initialize our kernels. <code>init_ipm</code> now
has a fifth argument - <code>uses_age</code>. This is a logical and
denotes that we are specifying a model with individuals cross-classified
by both age and size. The <code>sim_gen</code> argument is
<code>&quot;general</code>“, because age-size models are always general IPMs,
and <code>det_stoch = &quot;det&quot;</code> because we are only working on a
deterministic version of this model for now. We’ll append the
<code>_age</code> index to every variable that is age dependent.
Additionally, we can use <code>age</code> as a standalone term - these
will be substituted during the model building as well.</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a>age_size_ipm <span class="ot">&lt;-</span> <span class="fu">init_ipm</span>(<span class="at">sim_gen    =</span> <span class="st">&quot;general&quot;</span>,</span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a>                         <span class="at">di_dd      =</span> <span class="st">&quot;di&quot;</span>, </span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>                         <span class="at">det_stoch  =</span> <span class="st">&quot;det&quot;</span>,</span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a>                         <span class="at">uses_age    =</span> <span class="cn">TRUE</span>) <span class="sc">%&gt;%</span></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">name          =</span> <span class="st">&quot;P_age&quot;</span>,</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&quot;CC&quot;</span>,</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> s_age <span class="sc">*</span> g_age <span class="sc">*</span> d_wt,</span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">s_age         =</span> <span class="fu">inv_logit</span>(surv_int <span class="sc">+</span> surv_z <span class="sc">*</span> wt_1 <span class="sc">+</span> surv_a <span class="sc">*</span> age),</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">g_age         =</span> <span class="fu">dnorm</span>(wt_2, mu_g_age, grow_sd),</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">mu_g_age      =</span> grow_int <span class="sc">+</span> grow_z <span class="sc">*</span> wt_1 <span class="sc">+</span> grow_a <span class="sc">*</span> age,</span>
<span id="cb2-12"><a href="#cb2-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list     =</span> param_list,</span>
<span id="cb2-13"><a href="#cb2-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">states        =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&quot;wt&quot;</span>)),</span>
<span id="cb2-14"><a href="#cb2-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets =</span> <span class="cn">FALSE</span>,</span>
<span id="cb2-15"><a href="#cb2-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_indices   =</span> <span class="fu">list</span>(<span class="at">age =</span> <span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">20</span>), <span class="at">max_age =</span> <span class="dv">21</span>),</span>
<span id="cb2-16"><a href="#cb2-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor     =</span> <span class="cn">FALSE</span></span>
<span id="cb2-17"><a href="#cb2-17" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>The primary difference in defining this kernel vs any other indexed
model is that we now specify <code>uses_par_sets = FALSE</code>, and
pass a list to <code>age_indices</code> instead of
<code>par_set_indices</code>. <code>age_indices</code> takes a list with
at least one, but possibly two components:</p>
<ol style="list-style-type: decimal">
<li><p><code>age</code>: This is the age range for the model. It should
always start from 0 and be a sequence of integers.</p></li>
<li><p>Optionally, <code>max_age</code>: This is used to denote that
while individuals may get older in reality, this value will be the
highest that we model. In effect, it creates “very old, but not quite
dead” group which can survive and remain in the same age class.</p></li>
</ol>
<p>Next, we continue defining the models as we did before.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>age_size_ipm <span class="ot">&lt;-</span> </span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">proto_ipm     =</span> age_size_ipm,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">name          =</span> <span class="st">&quot;F_age&quot;</span>,</span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&quot;CC&quot;</span>,</span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> <span class="fu">f_fun</span>(age, s_age, pb_age, pr_age, rcsz) <span class="sc">*</span> d_wt,</span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">s_age         =</span> <span class="fu">inv_logit</span>(surv_int <span class="sc">+</span> surv_z <span class="sc">*</span> wt_1 <span class="sc">+</span> surv_a <span class="sc">*</span> age),</span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    <span class="at">pb_age        =</span> <span class="fu">inv_logit</span>(repr_int <span class="sc">+</span> repr_z <span class="sc">*</span> wt_1 <span class="sc">+</span> repr_a <span class="sc">*</span> age),</span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">pr_age        =</span> <span class="fu">inv_logit</span>(recr_int <span class="sc">+</span> recr_a <span class="sc">*</span> age),</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    <span class="at">rcsz          =</span> <span class="fu">dnorm</span>(wt_2, rcsz_mu, rcsz_sd),</span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">rcsz_mu       =</span> rcsz_int <span class="sc">+</span> rcsz_z <span class="sc">*</span> wt_1,</span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list     =</span> param_list,</span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="at">states        =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&quot;wt&quot;</span>)),</span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">age_indices   =</span> <span class="fu">list</span>(<span class="at">age =</span> <span class="fu">c</span>(<span class="dv">0</span><span class="sc">:</span><span class="dv">20</span>), <span class="at">max_age =</span> <span class="dv">21</span>),</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor     =</span> <span class="cn">FALSE</span></span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>The <code>&quot;F_age&quot;</code> kernel has a custom function in the
<code>formula</code> slot that allows us to always set fecundity for
age-0 individuals to 0. We also add <code>_age</code> suffixes and
<code>age</code> terms to the appropriate equations.</p>
<p>Our call to <code>define_impl()</code> will look a little different.
In examples in the other vignettes using the index syntax, we never
added indices to <code>state_start</code>/<code>state_end</code>.
However, we need to append them here. This is because we have to make
sure that our <code>P_age</code> kernels produce <code>wt_age</code>
individuals, whereas our <code>F_age</code> kernels must produce
<code>wt_0</code> individuals (i.e. only age-0 lambs). We do this using
the <code>state_start</code> and <code>state_end</code> arguments.</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>age_size_ipm <span class="ot">&lt;-</span> age_size_ipm <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_impl</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">make_impl_args_list</span>(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">kernel_names =</span> <span class="fu">c</span>(<span class="st">&quot;P_age&quot;</span>, <span class="st">&quot;F_age&quot;</span>),</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">int_rule     =</span> <span class="fu">rep</span>(<span class="st">&quot;midpoint&quot;</span>, <span class="dv">2</span>),</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">state_start    =</span> <span class="fu">c</span>(<span class="st">&quot;wt_age&quot;</span>, <span class="st">&quot;wt_age&quot;</span>),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">state_end      =</span> <span class="fu">c</span>(<span class="st">&quot;wt_age&quot;</span>, <span class="st">&quot;wt_0&quot;</span>)</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>  ) </span></code></pre></div>
<p>The rest of the steps are largely similar to previous examples:</p>
<ol style="list-style-type: decimal">
<li><p><code>define_domains()</code> is exactly the same.</p></li>
<li><p><code>define_pop_state()</code>: we append <code>_age</code>
suffix again here, because we want to track individual weights within
age groups. This will create 22 copies of the <code>wt</code> domain, 1
for each <code>age_indices</code>.</p></li>
<li><p>Optionally, <code>define_env_state()</code> (though not here
because it’s a deterministic model)</p></li>
<li><p><code>make_ipm()</code> is exactly the same.</p></li>
</ol>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>age_size_ipm <span class="ot">&lt;-</span> age_size_ipm <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_domains</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">wt =</span> <span class="fu">c</span>(<span class="fl">1.6</span>, <span class="fl">3.7</span>, <span class="dv">100</span>)</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_pop_state</span>(</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_wt_age =</span> <span class="fu">runif</span>(<span class="dv">100</span>)</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">make_ipm</span>(</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">usr_funs =</span> <span class="fu">list</span>(<span class="at">inv_logit =</span> inv_logit,</span>
<span id="cb5-10"><a href="#cb5-10" aria-hidden="true" tabindex="-1"></a>                    <span class="at">f_fun     =</span> f_fun),</span>
<span id="cb5-11"><a href="#cb5-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">iterate  =</span> <span class="cn">TRUE</span>,</span>
<span id="cb5-12"><a href="#cb5-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">iterations =</span> <span class="dv">100</span></span>
<span id="cb5-13"><a href="#cb5-13" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb5-14"><a href="#cb5-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb5-15"><a href="#cb5-15" aria-hidden="true" tabindex="-1"></a>lam <span class="ot">&lt;-</span> <span class="fu">lambda</span>(age_size_ipm)</span>
<span id="cb5-16"><a href="#cb5-16" aria-hidden="true" tabindex="-1"></a>lam</span></code></pre></div>
</div>
<div id="further-analyses" class="section level2">
<h2>Further analyses</h2>
<p>There are a number of other calculations that we can perform using
functions provided by <code>ipmr</code>. <code>left_ev()</code> and
<code>right_ev</code> also work for age <span class="math inline">\(\times\)</span> size models. We’ll extract them
and plot their values.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a>v_a <span class="ot">&lt;-</span> <span class="fu">left_ev</span>(age_size_ipm, <span class="at">iterations =</span> <span class="dv">100</span>)</span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a>w_a <span class="ot">&lt;-</span> <span class="fu">right_ev</span>(age_size_ipm, <span class="at">iterations =</span> <span class="dv">100</span>)</span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">2</span>))</span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(<span class="fu">unlist</span>(w_a)), <span class="at">length.out =</span> <span class="dv">100</span>), <span class="at">type =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">&quot;w&quot;</span>[a],<span class="st">&quot;(z)&quot;</span>)),</span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">&quot;Size bin&quot;</span>)</span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(w_a)) {</span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">lines</span>(w_a[[i]])</span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">100</span>, </span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>     <span class="fu">seq</span>(<span class="dv">0</span>, <span class="fu">max</span>(<span class="fu">unlist</span>(v_a)), <span class="at">length.out =</span> <span class="dv">100</span>),</span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>     <span class="at">type =</span> <span class="st">&quot;n&quot;</span>,</span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>     <span class="at">ylab =</span> <span class="fu">expression</span>(<span class="fu">paste</span>(<span class="st">&quot;v&quot;</span>[a], <span class="st">&quot;(z)&quot;</span>)),</span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>     <span class="at">xlab =</span> <span class="st">&quot;Size bin&quot;</span>)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a><span class="cf">for</span>(i <span class="cf">in</span> <span class="fu">seq_along</span>(v_a)) {</span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a> <span class="fu">lines</span>(v_a[[i]]) </span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
