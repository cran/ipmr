<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />



<title>General IPMs</title>

<script src="data:application/javascript;base64,Ly8gUGFuZG9jIDIuOSBhZGRzIGF0dHJpYnV0ZXMgb24gYm90aCBoZWFkZXIgYW5kIGRpdi4gV2UgcmVtb3ZlIHRoZSBmb3JtZXIgKHRvCi8vIGJlIGNvbXBhdGlibGUgd2l0aCB0aGUgYmVoYXZpb3Igb2YgUGFuZG9jIDwgMi44KS4KZG9jdW1lbnQuYWRkRXZlbnRMaXN0ZW5lcignRE9NQ29udGVudExvYWRlZCcsIGZ1bmN0aW9uKGUpIHsKICB2YXIgaHMgPSBkb2N1bWVudC5xdWVyeVNlbGVjdG9yQWxsKCJkaXYuc2VjdGlvbltjbGFzcyo9J2xldmVsJ10gPiA6Zmlyc3QtY2hpbGQiKTsKICB2YXIgaSwgaCwgYTsKICBmb3IgKGkgPSAwOyBpIDwgaHMubGVuZ3RoOyBpKyspIHsKICAgIGggPSBoc1tpXTsKICAgIGlmICghL15oWzEtNl0kL2kudGVzdChoLnRhZ05hbWUpKSBjb250aW51ZTsgIC8vIGl0IHNob3VsZCBiZSBhIGhlYWRlciBoMS1oNgogICAgYSA9IGguYXR0cmlidXRlczsKICAgIHdoaWxlIChhLmxlbmd0aCA+IDApIGgucmVtb3ZlQXR0cmlidXRlKGFbMF0ubmFtZSk7CiAgfQp9KTsK"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="data:text/css,body%20%7B%0Abackground%2Dcolor%3A%20%23fff%3B%0Amargin%3A%201em%20auto%3B%0Amax%2Dwidth%3A%20700px%3B%0Aoverflow%3A%20visible%3B%0Apadding%2Dleft%3A%202em%3B%0Apadding%2Dright%3A%202em%3B%0Afont%2Dfamily%3A%20%22Open%20Sans%22%2C%20%22Helvetica%20Neue%22%2C%20Helvetica%2C%20Arial%2C%20sans%2Dserif%3B%0Afont%2Dsize%3A%2014px%3B%0Aline%2Dheight%3A%201%2E35%3B%0A%7D%0A%23TOC%20%7B%0Aclear%3A%20both%3B%0Amargin%3A%200%200%2010px%2010px%3B%0Apadding%3A%204px%3B%0Awidth%3A%20400px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Aborder%2Dradius%3A%205px%3B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Afont%2Dsize%3A%2013px%3B%0Aline%2Dheight%3A%201%2E3%3B%0A%7D%0A%23TOC%20%2Etoctitle%20%7B%0Afont%2Dweight%3A%20bold%3B%0Afont%2Dsize%3A%2015px%3B%0Amargin%2Dleft%3A%205px%3B%0A%7D%0A%23TOC%20ul%20%7B%0Apadding%2Dleft%3A%2040px%3B%0Amargin%2Dleft%3A%20%2D1%2E5em%3B%0Amargin%2Dtop%3A%205px%3B%0Amargin%2Dbottom%3A%205px%3B%0A%7D%0A%23TOC%20ul%20ul%20%7B%0Amargin%2Dleft%3A%20%2D2em%3B%0A%7D%0A%23TOC%20li%20%7B%0Aline%2Dheight%3A%2016px%3B%0A%7D%0Atable%20%7B%0Amargin%3A%201em%20auto%3B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dcolor%3A%20%23DDDDDD%3B%0Aborder%2Dstyle%3A%20outset%3B%0Aborder%2Dcollapse%3A%20collapse%3B%0A%7D%0Atable%20th%20%7B%0Aborder%2Dwidth%3A%202px%3B%0Apadding%3A%205px%3B%0Aborder%2Dstyle%3A%20inset%3B%0A%7D%0Atable%20td%20%7B%0Aborder%2Dwidth%3A%201px%3B%0Aborder%2Dstyle%3A%20inset%3B%0Aline%2Dheight%3A%2018px%3B%0Apadding%3A%205px%205px%3B%0A%7D%0Atable%2C%20table%20th%2C%20table%20td%20%7B%0Aborder%2Dleft%2Dstyle%3A%20none%3B%0Aborder%2Dright%2Dstyle%3A%20none%3B%0A%7D%0Atable%20thead%2C%20table%20tr%2Eeven%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Ap%20%7B%0Amargin%3A%200%2E5em%200%3B%0A%7D%0Ablockquote%20%7B%0Abackground%2Dcolor%3A%20%23f6f6f6%3B%0Apadding%3A%200%2E25em%200%2E75em%3B%0A%7D%0Ahr%20%7B%0Aborder%2Dstyle%3A%20solid%3B%0Aborder%3A%20none%3B%0Aborder%2Dtop%3A%201px%20solid%20%23777%3B%0Amargin%3A%2028px%200%3B%0A%7D%0Adl%20%7B%0Amargin%2Dleft%3A%200%3B%0A%7D%0Adl%20dd%20%7B%0Amargin%2Dbottom%3A%2013px%3B%0Amargin%2Dleft%3A%2013px%3B%0A%7D%0Adl%20dt%20%7B%0Afont%2Dweight%3A%20bold%3B%0A%7D%0Aul%20%7B%0Amargin%2Dtop%3A%200%3B%0A%7D%0Aul%20li%20%7B%0Alist%2Dstyle%3A%20circle%20outside%3B%0A%7D%0Aul%20ul%20%7B%0Amargin%2Dbottom%3A%200%3B%0A%7D%0Apre%2C%20code%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0Aborder%2Dradius%3A%203px%3B%0Acolor%3A%20%23333%3B%0Awhite%2Dspace%3A%20pre%2Dwrap%3B%20%0A%7D%0Apre%20%7B%0Aborder%2Dradius%3A%203px%3B%0Amargin%3A%205px%200px%2010px%200px%3B%0Apadding%3A%2010px%3B%0A%7D%0Apre%3Anot%28%5Bclass%5D%29%20%7B%0Abackground%2Dcolor%3A%20%23f7f7f7%3B%0A%7D%0Acode%20%7B%0Afont%2Dfamily%3A%20Consolas%2C%20Monaco%2C%20%27Courier%20New%27%2C%20monospace%3B%0Afont%2Dsize%3A%2085%25%3B%0A%7D%0Ap%20%3E%20code%2C%20li%20%3E%20code%20%7B%0Apadding%3A%202px%200px%3B%0A%7D%0Adiv%2Efigure%20%7B%0Atext%2Dalign%3A%20center%3B%0A%7D%0Aimg%20%7B%0Abackground%2Dcolor%3A%20%23FFFFFF%3B%0Apadding%3A%202px%3B%0Aborder%3A%201px%20solid%20%23DDDDDD%3B%0Aborder%2Dradius%3A%203px%3B%0Aborder%3A%201px%20solid%20%23CCCCCC%3B%0Amargin%3A%200%205px%3B%0A%7D%0Ah1%20%7B%0Amargin%2Dtop%3A%200%3B%0Afont%2Dsize%3A%2035px%3B%0Aline%2Dheight%3A%2040px%3B%0A%7D%0Ah2%20%7B%0Aborder%2Dbottom%3A%204px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Apadding%2Dbottom%3A%202px%3B%0Afont%2Dsize%3A%20145%25%3B%0A%7D%0Ah3%20%7B%0Aborder%2Dbottom%3A%202px%20solid%20%23f7f7f7%3B%0Apadding%2Dtop%3A%2010px%3B%0Afont%2Dsize%3A%20120%25%3B%0A%7D%0Ah4%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23f7f7f7%3B%0Amargin%2Dleft%3A%208px%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Ah5%2C%20h6%20%7B%0Aborder%2Dbottom%3A%201px%20solid%20%23ccc%3B%0Afont%2Dsize%3A%20105%25%3B%0A%7D%0Aa%20%7B%0Acolor%3A%20%230033dd%3B%0Atext%2Ddecoration%3A%20none%3B%0A%7D%0Aa%3Ahover%20%7B%0Acolor%3A%20%236666ff%3B%20%7D%0Aa%3Avisited%20%7B%0Acolor%3A%20%23800080%3B%20%7D%0Aa%3Avisited%3Ahover%20%7B%0Acolor%3A%20%23BB00BB%3B%20%7D%0Aa%5Bhref%5E%3D%22http%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0Aa%5Bhref%5E%3D%22https%3A%22%5D%20%7B%0Atext%2Ddecoration%3A%20underline%3B%20%7D%0A%0Acode%20%3E%20span%2Ekw%20%7B%20color%3A%20%23555%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Edt%20%7B%20color%3A%20%23902000%3B%20%7D%20%0Acode%20%3E%20span%2Edv%20%7B%20color%3A%20%2340a070%3B%20%7D%20%0Acode%20%3E%20span%2Ebn%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Efl%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Ech%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Est%20%7B%20color%3A%20%23d14%3B%20%7D%20%0Acode%20%3E%20span%2Eco%20%7B%20color%3A%20%23888888%3B%20font%2Dstyle%3A%20italic%3B%20%7D%20%0Acode%20%3E%20span%2Eot%20%7B%20color%3A%20%23007020%3B%20%7D%20%0Acode%20%3E%20span%2Eal%20%7B%20color%3A%20%23ff0000%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Efu%20%7B%20color%3A%20%23900%3B%20font%2Dweight%3A%20bold%3B%20%7D%20%0Acode%20%3E%20span%2Eer%20%7B%20color%3A%20%23a61717%3B%20background%2Dcolor%3A%20%23e3d2d2%3B%20%7D%20%0A" type="text/css" />




</head>

<body>




<h1 class="title toc-ignore">General IPMs</h1>


<div id="TOC">
<ul>
<li><a href="#simple-ipms-vs-general-ipms">Simple IPMs vs General IPMs</a></li>
<li><a href="#a-general-density-independent-deterministic-ipm">A general, density independent, deterministic IPM</a>
<ul>
<li><a href="#key-differences-between-simple-and-general-ipms.">Key differences between simple and general IPMs.</a></li>
<li><a href="#mathematical-overview-of-the-example">Mathematical overview of the example</a></li>
<li><a href="#model-code">Model code</a></li>
<li><a href="#further-analysis">Further analysis</a></li>
</ul></li>
<li><a href="#general-models-for-discretely-varying-environments">General models for discretely varying environments</a>
<ul>
<li><a href="#mathematical-overview-of-the-example-1">Mathematical overview of the example</a></li>
<li><a href="#model-parameterization">Model parameterization</a></li>
</ul></li>
<li><a href="#general-models-with-continuously-varying-environments">General models with continuously varying environments</a>
<ul>
<li><a href="#mathematical-overview">Mathematical overview</a></li>
<li><a href="#model-parameterization-1">Model parameterization</a></li>
<li><a href="#model-specification">Model specification</a></li>
</ul></li>
<li><a href="#code-to-construct-mega-kernels">Code to construct mega-kernels</a></li>
</ul>
</div>

<div id="simple-ipms-vs-general-ipms" class="section level2">
<h2>Simple IPMs vs General IPMs</h2>
<p>In the <a href="https://levisc8.github.io/ipmr/articles/ipmr-introduction.html">introduction vignette</a>, we reviewed some basic IPM theory and worked through examples of simple IPMs, which only model a single, continuously distributed state variable. General IPMs are distinguished from simple ones in that they incorporate multiple state variables and/or include transitions between continuous and discrete states. These state variables could be, for example, a continuous measure of coral colony surface area and a discrete state to denote aspergillosis infection (in <a href="https://esajournals.onlinelibrary.wiley.com/doi/full/10.1890/09-1178.1">Bruno et al. 2011</a>), a mixture of trees classified by basal diameter and a discrete state for seeds in a seed bank (in <a href="https://besjournals.onlinelibrary.wiley.com/doi/10.1111/1365-2664.13020">Crandall &amp; Knight 2017</a>), or a mixture of multiple continuous and discrete state (e.g. <a href="https://esajournals.onlinelibrary.wiley.com/doi/pdf/10.1890/13-1478.1">Aikens &amp; Roach 2014</a>). A more comprehensive definition is provided in <a href="https://pubmed.ncbi.nlm.nih.gov/16673349/">Ellner &amp; Rees (2006)</a> and in Ellner, Childs &amp; Rees, Chapter 6 (2016).</p>
</div>
<div id="a-general-density-independent-deterministic-ipm" class="section level2">
<h2>A general, density independent, deterministic IPM</h2>
<p>We’ll start with the least complicated of the general IPMs and build progressively from there. If you’ve already read through the introduction vignette, then most of this will look pretty familiar. If not, it is probably best to at least skim the first few sections before proceeding here.</p>
<div id="key-differences-between-simple-and-general-ipms." class="section level3">
<h3>Key differences between simple and general IPMs.</h3>
<p>As noted above, we are now working with models that may have multiple continuous state variables and/or discrete states to describe the demography of our species. Thus, we need to add some more information to the model’s definition in order to fully capture these additional demographic details.</p>
<p>Relative to how we define simple models in <code>ipmr</code>, there are now two new bits:</p>
<ol style="list-style-type: decimal">
<li><p>Each kernel that has an integration requires that <code>d_statevariable</code> get appended to the kernel <code>formula</code>. This is equivalent to the “dz” in <span class="math inline">\(\int_L^U K(z&#39;,z) n(z,t) \mathrm{dz}\)</span>. <code>ipmr</code> automatically generates this variable internally, so there is no need to define it in the <code>data_list</code> or <code>define_domains()</code>, we can just add it any of the formula(s) that we want to. We skipped this step in the simple IPMs because it gets appended automatically. Unfortunately, it is less easy to infer the correct state variable to <code>d_z</code> with for general IPMs where there may be many continuous and/or discrete states.</p></li>
<li><p>The implementation arguments list can now have different values in the <code>state_start</code> and <code>state_end</code> slots. This is demonstrated in a separate chunk below.</p></li>
</ol>
</div>
<div id="mathematical-overview-of-the-example" class="section level3">
<h3>Mathematical overview of the example</h3>
<p>This example will use an IPM for <em>Ligustrum obtusifolium</em>, a tree species that is now invasive in North America. Data were collected outside of St. Louis, Missouri, and the full model is described in <a href="https://esajournals.onlinelibrary.wiley.com/action/downloadSupplement?doi=10.1002%2Fecy.2681&amp;file=ecy2681-sup-0002-MetadataS1.pdf">Levin et al. 2019</a>. The IPM consists of a single discrete stage (seed bank, abbreviated <code>b</code>) and a single continuous state (height, abbreviated <code>ht</code>/<span class="math inline">\(z,z&#39;\)</span>). The census timing was such that all seeds must enter the seed bank. They can either germinate in the next year, or they can die (so <code>stay_discrete</code> = 0). Thus, the full model takes the following form:</p>
<ol style="list-style-type: decimal">
<li><p><span class="math inline">\(n(z&#39;, t + 1) = \int_L^U P(z&#39;, z) n(z,t)d\mathrm{z} + b(t) * \int_L^U leave\_discrete(z&#39;) \mathrm{dz&#39;}\)</span></p></li>
<li><p><span class="math inline">\(b(t + 1) = \int_L^Ugo\_discrete(z) n(z,t)d\mathrm{z}+ stay\_discrete\)</span></p></li>
<li><p><span class="math inline">\(P(z&#39;,z) = s(z) * G(z&#39;,z)\)</span></p></li>
<li><p><span class="math inline">\(go\_discrete(z) = f_s(z) * f_r(z) * g_i\)</span></p></li>
<li><p><span class="math inline">\(leave\_discrete(z&#39;) = e_p * f_d(z&#39;)\)</span></p></li>
<li><p><span class="math inline">\(stay\_discrete = 0\)</span></p></li>
</ol>
<p><span class="math inline">\(f_G\)</span> and <span class="math inline">\(f_{r_d}\)</span> denote Normal probability density functions. The vital rates functions and example code to fit them are:</p>
<ol style="list-style-type: decimal">
<li><p>survival (<code>s</code>): A logistic regression with a squared term</p>
<ul>
<li><p>Example code: <code>glm(surv ~ ht_1 + I(ht_1)^2, data = my_surv_data, family = binomial())</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Logit(s(z)) = \alpha_s + \beta_{s,1} * z + \beta_{s,2} * z^2\)</span></p></li>
</ul></li>
<li><p>growth (<code>g</code>): A linear regression</p>
<ul>
<li><p>example code: <code>lm(ht_2 ~ ht_1, data = grow_data)</code></p></li>
<li><p>Mathematical form:</p>
<ul>
<li><p><span class="math inline">\(\mu_G = \alpha_G + \beta_G * z\)</span></p></li>
<li><p><span class="math inline">\(G(z&#39;,z) = f_G(\mu_G, \sigma_G)\)</span></p></li>
</ul></li>
</ul></li>
<li><p>flowering probability (<code>r_r</code>): A logistic regression</p>
<ul>
<li><p>example code: <code>glm(repro ~ ht_1, data = my_repro_data, family = binomial())</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Logit(r_r(z)) = \alpha_{r_r} + \beta_{r_r} * z\)</span></p></li>
</ul></li>
<li><p>seed production (<code>r_s</code>): A Poisson regression</p>
<ul>
<li><p>example code: <code>glm(seeds ~ ht_1, data = my_seed_data, family = poisson())</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Log(r_s(z)) = \alpha_{r_s} + \beta_{r_s} * z\)</span></p></li>
</ul></li>
<li><p>Recruit size distribution (<code>r_d</code>): A normal distribution with mean <code>r_d_mu</code> and standard deviation <code>r_d_sd</code>.</p>
<ul>
<li><p>example code: <code>r_d_mu &lt;- mean(my_recr_data$ht_2, na.rm = TRUE)</code> and <code>r_d_sd &lt;- sd(my_rer_data$ht_2, na.rm = TRUE)</code>.</p></li>
<li><p>Mathematical form: <span class="math inline">\(r_d(z&#39;) = f_{r_d}(\mu_{r_d}, \sigma_{r_d})\)</span></p></li>
</ul></li>
<li><p>germination (<code>g_i</code>) and establishment (<code>e_p</code>) are constants. The code below assumes we have our data in long format (each seed get its own row) and that successful germination/establishment is coded as 1s, failures are 0s, and seeds we don’t know the fate of for whatever reason are <code>NA</code>s.</p>
<ul>
<li><p>example code: <code>g_i &lt;- mean(my_germ_data, na.rm = TRUE)</code> and <code>e_p &lt;- mean(my_est_data, na.rm = TRUE)</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(g_i = 0.5067, e_p = 0.15\)</span></p></li>
</ul></li>
</ol>
</div>
<div id="model-code" class="section level3">
<h3>Model code</h3>
<p>Below is the code to implement this model. First, we define our our parameters in a list.</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ipmr)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-3"><a href="#cb1-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up the initial population conditions and parameters</span></span>
<span id="cb1-4"><a href="#cb1-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb1-5"><a href="#cb1-5" aria-hidden="true" tabindex="-1"></a>data_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb1-6"><a href="#cb1-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_int     =</span> <span class="fl">5.781</span>,</span>
<span id="cb1-7"><a href="#cb1-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_slope   =</span> <span class="fl">0.988</span>,</span>
<span id="cb1-8"><a href="#cb1-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_sd      =</span> <span class="fl">20.55699</span>,</span>
<span id="cb1-9"><a href="#cb1-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_int     =</span> <span class="sc">-</span><span class="fl">0.352</span>,</span>
<span id="cb1-10"><a href="#cb1-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_slope   =</span> <span class="fl">0.122</span>,</span>
<span id="cb1-11"><a href="#cb1-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_slope_2 =</span> <span class="sc">-</span><span class="fl">0.000213</span>,</span>
<span id="cb1-12"><a href="#cb1-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_r_int   =</span> <span class="sc">-</span><span class="fl">11.46</span>,</span>
<span id="cb1-13"><a href="#cb1-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_r_slope =</span> <span class="fl">0.0835</span>,</span>
<span id="cb1-14"><a href="#cb1-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_s_int   =</span> <span class="fl">2.6204</span>,</span>
<span id="cb1-15"><a href="#cb1-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_s_slope =</span> <span class="fl">0.01256</span>,</span>
<span id="cb1-16"><a href="#cb1-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_d_mu    =</span> <span class="fl">5.6655</span>,</span>
<span id="cb1-17"><a href="#cb1-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_d_sd    =</span> <span class="fl">2.0734</span>,</span>
<span id="cb1-18"><a href="#cb1-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">e_p       =</span> <span class="fl">0.15</span>,</span>
<span id="cb1-19"><a href="#cb1-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_i       =</span> <span class="fl">0.5067</span></span>
<span id="cb1-20"><a href="#cb1-20" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>Next, we set up two functions to pass into the model. These perform the inverse logit transformations for the probability of flowering model (<code>r_r</code>/<span class="math inline">\(r_r(z)\)</span>) and survival model (<code>s</code>/<span class="math inline">\(s(z)\)</span>).</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># We&#39;ll set up some helper functions. The survival function</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># in this model is a quadratic function, so we use an additional inverse logit function</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a><span class="co"># that can handle the quadratic term.</span></span>
<span id="cb2-4"><a href="#cb2-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" aria-hidden="true" tabindex="-1"></a>inv_logit <span class="ot">&lt;-</span> <span class="cf">function</span>(int, slope, sv) {</span>
<span id="cb2-6"><a href="#cb2-6" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>(int <span class="sc">+</span> slope <span class="sc">*</span> sv)))</span>
<span id="cb2-7"><a href="#cb2-7" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb2-8"><a href="#cb2-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" aria-hidden="true" tabindex="-1"></a>inv_logit_2 <span class="ot">&lt;-</span> <span class="cf">function</span>(int, slope, slope_2, sv) {</span>
<span id="cb2-10"><a href="#cb2-10" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>(int <span class="sc">+</span> slope <span class="sc">*</span> sv <span class="sc">+</span> slope_2 <span class="sc">*</span> sv <span class="sc">^</span> <span class="dv">2</span>)))</span>
<span id="cb2-11"><a href="#cb2-11" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Now, we’re ready to begin making the IPM kernels. We change the <code>sim_gen</code> argument of <code>init_ipm()</code> to <code>&quot;general&quot;</code>.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a>general_ipm <span class="ot">&lt;-</span> <span class="fu">init_ipm</span>(<span class="at">sim_gen =</span> <span class="st">&quot;general&quot;</span>, <span class="at">di_dd =</span> <span class="st">&quot;di&quot;</span>, <span class="at">det_stoch =</span> <span class="st">&quot;det&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">name          =</span> <span class="st">&quot;P&quot;</span>,</span>
<span id="cb3-4"><a href="#cb3-4" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-5"><a href="#cb3-5" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We add d_ht to formula to make sure integration is handled correctly.</span></span>
<span id="cb3-6"><a href="#cb3-6" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This variable is generated internally by make_ipm(), so we don&#39;t need</span></span>
<span id="cb3-7"><a href="#cb3-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to do anything else.</span></span>
<span id="cb3-8"><a href="#cb3-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-9"><a href="#cb3-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> s <span class="sc">*</span> g <span class="sc">*</span> d_ht,</span>
<span id="cb3-10"><a href="#cb3-10" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-11"><a href="#cb3-11" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The family argument tells ipmr what kind of transition this kernel describes.</span></span>
<span id="cb3-12"><a href="#cb3-12" aria-hidden="true" tabindex="-1"></a>    <span class="co"># it can be &quot;CC&quot; for continuous -&gt; continuous, &quot;DC&quot; for discrete -&gt; continuous</span></span>
<span id="cb3-13"><a href="#cb3-13" aria-hidden="true" tabindex="-1"></a>    <span class="co"># &quot;CD&quot; for continuous -&gt; discrete, or &quot;DD&quot; for discrete -&gt; discrete.</span></span>
<span id="cb3-14"><a href="#cb3-14" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-15"><a href="#cb3-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&quot;CC&quot;</span>,</span>
<span id="cb3-16"><a href="#cb3-16" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-17"><a href="#cb3-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The rest of the arguments are exactly the same as in the simple models</span></span>
<span id="cb3-18"><a href="#cb3-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-19"><a href="#cb3-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">g             =</span> <span class="fu">dnorm</span>(ht_2, g_mu, g_sd),</span>
<span id="cb3-20"><a href="#cb3-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">g_mu          =</span> g_int <span class="sc">+</span> g_slope <span class="sc">*</span> ht_1,</span>
<span id="cb3-21"><a href="#cb3-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">s             =</span> <span class="fu">inv_logit_2</span>(s_int, s_slope, s_slope_2, ht_1),</span>
<span id="cb3-22"><a href="#cb3-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list     =</span> data_list,</span>
<span id="cb3-23"><a href="#cb3-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">states        =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>)),</span>
<span id="cb3-24"><a href="#cb3-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-25"><a href="#cb3-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor     =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-26"><a href="#cb3-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_fun     =</span> <span class="fu">truncated_distributions</span>(<span class="st">&#39;norm&#39;</span>,</span>
<span id="cb3-27"><a href="#cb3-27" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">&#39;g&#39;</span>)</span>
<span id="cb3-28"><a href="#cb3-28" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb3-29"><a href="#cb3-29" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb3-30"><a href="#cb3-30" aria-hidden="true" tabindex="-1"></a>    <span class="at">name          =</span> <span class="st">&quot;go_discrete&quot;</span>,</span>
<span id="cb3-31"><a href="#cb3-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> r_r <span class="sc">*</span> r_s <span class="sc">*</span> g_i <span class="sc">*</span> d_ht,</span>
<span id="cb3-32"><a href="#cb3-32" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-33"><a href="#cb3-33" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note that now, family = &quot;CD&quot; because it denotes a continuous -&gt; discrete transition</span></span>
<span id="cb3-34"><a href="#cb3-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-35"><a href="#cb3-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&#39;CD&#39;</span>,</span>
<span id="cb3-36"><a href="#cb3-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">r_r           =</span> <span class="fu">inv_logit</span>(r_r_int, r_r_slope, ht_1),</span>
<span id="cb3-37"><a href="#cb3-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">r_s           =</span> <span class="fu">exp</span>(r_s_int <span class="sc">+</span> r_s_slope <span class="sc">*</span> ht_1),</span>
<span id="cb3-38"><a href="#cb3-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list     =</span> data_list,</span>
<span id="cb3-39"><a href="#cb3-39" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-40"><a href="#cb3-40" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note that here, we add &quot;b&quot; to our list in states, because this kernel</span></span>
<span id="cb3-41"><a href="#cb3-41" aria-hidden="true" tabindex="-1"></a>    <span class="co"># &quot;creates&quot; seeds entering the seedbank</span></span>
<span id="cb3-42"><a href="#cb3-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-43"><a href="#cb3-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">states        =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>, <span class="st">&quot;b&quot;</span>)),</span>
<span id="cb3-44"><a href="#cb3-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets =</span> <span class="cn">FALSE</span></span>
<span id="cb3-45"><a href="#cb3-45" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb3-46"><a href="#cb3-46" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb3-47"><a href="#cb3-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">name    =</span> <span class="st">&#39;stay_discrete&#39;</span>,</span>
<span id="cb3-48"><a href="#cb3-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-49"><a href="#cb3-49" aria-hidden="true" tabindex="-1"></a>    <span class="co"># In this case, seeds in the seed bank either germinate or die, but they </span></span>
<span id="cb3-50"><a href="#cb3-50" aria-hidden="true" tabindex="-1"></a>    <span class="co"># do not remain for multiple time steps. This can be adjusted as needed.</span></span>
<span id="cb3-51"><a href="#cb3-51" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-52"><a href="#cb3-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="dv">0</span>,</span>
<span id="cb3-53"><a href="#cb3-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-54"><a href="#cb3-54" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note that now, family = &quot;DD&quot; becuase it denotes a discrete -&gt; discrete transition</span></span>
<span id="cb3-55"><a href="#cb3-55" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-56"><a href="#cb3-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">family  =</span> <span class="st">&quot;DD&quot;</span>,</span>
<span id="cb3-57"><a href="#cb3-57" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-58"><a href="#cb3-58" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The only state variable this operates on is &quot;b&quot;, so we can leave &quot;ht&quot;</span></span>
<span id="cb3-59"><a href="#cb3-59" aria-hidden="true" tabindex="-1"></a>    <span class="co"># out of the states list</span></span>
<span id="cb3-60"><a href="#cb3-60" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-61"><a href="#cb3-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">states  =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;b&#39;</span>)),</span>
<span id="cb3-62"><a href="#cb3-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor =</span> <span class="cn">FALSE</span></span>
<span id="cb3-63"><a href="#cb3-63" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb3-64"><a href="#cb3-64" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb3-65"><a href="#cb3-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-66"><a href="#cb3-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Here, the family changes to &quot;DC&quot; because it is the discrete -&gt; continuous </span></span>
<span id="cb3-67"><a href="#cb3-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># transition</span></span>
<span id="cb3-68"><a href="#cb3-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-69"><a href="#cb3-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">name          =</span> <span class="st">&#39;leave_discrete&#39;</span>,</span>
<span id="cb3-70"><a href="#cb3-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-71"><a href="#cb3-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We append d_ht here as well, because we need to integrate over the </span></span>
<span id="cb3-72"><a href="#cb3-72" aria-hidden="true" tabindex="-1"></a>    <span class="co"># the recruit size distribution.</span></span>
<span id="cb3-73"><a href="#cb3-73" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-74"><a href="#cb3-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> e_p <span class="sc">*</span> r_d <span class="sc">*</span> d_ht,</span>
<span id="cb3-75"><a href="#cb3-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">r_d           =</span> <span class="fu">dnorm</span>(ht_2, r_d_mu, r_d_sd),</span>
<span id="cb3-76"><a href="#cb3-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&#39;DC&#39;</span>,</span>
<span id="cb3-77"><a href="#cb3-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list     =</span> data_list,</span>
<span id="cb3-78"><a href="#cb3-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-79"><a href="#cb3-79" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Again, we need to add &quot;b&quot; to the states list</span></span>
<span id="cb3-80"><a href="#cb3-80" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb3-81"><a href="#cb3-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">states        =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>, <span class="st">&quot;b&quot;</span>)),</span>
<span id="cb3-82"><a href="#cb3-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets =</span> <span class="cn">FALSE</span>,</span>
<span id="cb3-83"><a href="#cb3-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor     =</span> <span class="cn">TRUE</span>,</span>
<span id="cb3-84"><a href="#cb3-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_fun     =</span> <span class="fu">truncated_distributions</span>(<span class="st">&#39;norm&#39;</span>,</span>
<span id="cb3-85"><a href="#cb3-85" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">&#39;r_d&#39;</span>)</span>
<span id="cb3-86"><a href="#cb3-86" aria-hidden="true" tabindex="-1"></a>  ) </span></code></pre></div>
<p>We’ve now defined all of the kernels, next are the implementation details. These also differ somewhat from simple IPMs. The key difference in the implementation arguments list lies in the <code>state_start</code> and <code>state_end</code> of each kernel, and is related to the <code>family</code> argument of each kernel. Kernels that begin with one state and end in a different state (e.g. moving from seed bank to a plant) will have different entries in the <code>state_start</code> and <code>state_end</code> slots. It is very important to get these correct, as <code>ipmr</code> uses this information to generate the model iteration procedure automatically (i.e. code corresponding to Equations 1-2).</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a>general_ipm <span class="ot">&lt;-</span> general_ipm <span class="sc">%&gt;%</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_impl</span>(</span>
<span id="cb4-3"><a href="#cb4-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">list</span>(</span>
<span id="cb4-4"><a href="#cb4-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">P              =</span> <span class="fu">list</span>(<span class="at">int_rule    =</span> <span class="st">&quot;midpoint&quot;</span>,</span>
<span id="cb4-5"><a href="#cb4-5" aria-hidden="true" tabindex="-1"></a>                            <span class="at">state_start =</span> <span class="st">&quot;ht&quot;</span>,</span>
<span id="cb4-6"><a href="#cb4-6" aria-hidden="true" tabindex="-1"></a>                            <span class="at">state_end   =</span> <span class="st">&quot;ht&quot;</span>),</span>
<span id="cb4-7"><a href="#cb4-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">go_discrete    =</span> <span class="fu">list</span>(<span class="at">int_rule    =</span> <span class="st">&quot;midpoint&quot;</span>,</span>
<span id="cb4-8"><a href="#cb4-8" aria-hidden="true" tabindex="-1"></a>                            <span class="at">state_start =</span> <span class="st">&quot;ht&quot;</span>,</span>
<span id="cb4-9"><a href="#cb4-9" aria-hidden="true" tabindex="-1"></a>                            <span class="at">state_end   =</span> <span class="st">&quot;b&quot;</span>),</span>
<span id="cb4-10"><a href="#cb4-10" aria-hidden="true" tabindex="-1"></a>      <span class="at">stay_discrete  =</span> <span class="fu">list</span>(<span class="at">int_rule    =</span> <span class="st">&quot;midpoint&quot;</span>,</span>
<span id="cb4-11"><a href="#cb4-11" aria-hidden="true" tabindex="-1"></a>                            <span class="at">state_start =</span> <span class="st">&quot;b&quot;</span>,</span>
<span id="cb4-12"><a href="#cb4-12" aria-hidden="true" tabindex="-1"></a>                            <span class="at">state_end   =</span> <span class="st">&quot;b&quot;</span>),</span>
<span id="cb4-13"><a href="#cb4-13" aria-hidden="true" tabindex="-1"></a>      <span class="at">leave_discrete =</span> <span class="fu">list</span>(<span class="at">int_rule    =</span> <span class="st">&quot;midpoint&quot;</span>,</span>
<span id="cb4-14"><a href="#cb4-14" aria-hidden="true" tabindex="-1"></a>                            <span class="at">state_start =</span> <span class="st">&quot;b&quot;</span>,</span>
<span id="cb4-15"><a href="#cb4-15" aria-hidden="true" tabindex="-1"></a>                            <span class="at">state_end   =</span> <span class="st">&quot;ht&quot;</span>)</span>
<span id="cb4-16"><a href="#cb4-16" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb4-17"><a href="#cb4-17" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>An alternative to the list above is to use <code>make_impl_args_list()</code>. The chunk above and the chunk below generate equivalent <code>proto_ipm</code> objects.</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" aria-hidden="true" tabindex="-1"></a>general_ipm <span class="ot">&lt;-</span> general_ipm <span class="sc">%&gt;%</span></span>
<span id="cb5-2"><a href="#cb5-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_impl</span>(</span>
<span id="cb5-3"><a href="#cb5-3" aria-hidden="true" tabindex="-1"></a>    <span class="fu">make_impl_args_list</span>(</span>
<span id="cb5-4"><a href="#cb5-4" aria-hidden="true" tabindex="-1"></a>      <span class="at">kernel_names =</span> <span class="fu">c</span>(<span class="st">&quot;P&quot;</span>, <span class="st">&quot;go_discrete&quot;</span>, <span class="st">&quot;stay_discrete&quot;</span>, <span class="st">&quot;leave_discrete&quot;</span>),</span>
<span id="cb5-5"><a href="#cb5-5" aria-hidden="true" tabindex="-1"></a>      <span class="at">int_rule     =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&quot;midpoint&quot;</span>, <span class="dv">4</span>)),</span>
<span id="cb5-6"><a href="#cb5-6" aria-hidden="true" tabindex="-1"></a>      <span class="at">state_start    =</span> <span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>, <span class="st">&quot;ht&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;b&quot;</span>),</span>
<span id="cb5-7"><a href="#cb5-7" aria-hidden="true" tabindex="-1"></a>      <span class="at">state_end      =</span> <span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&#39;ht&#39;</span>)</span>
<span id="cb5-8"><a href="#cb5-8" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb5-9"><a href="#cb5-9" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>The rest is the same as the simple IPM. We can use our pre-defined functions in <code>make_ipm</code>, and we can use pre-defined variables in <code>define_domains</code>. We’ll create variables for the upper (<code>U</code>) and lower (<code>L</code>) size bounds for the population, and the number of meshpoints for integration (<code>n</code>). We also define initial population vectors for both <code>b</code> and <code>ht</code>.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="co"># The lower and upper bounds for the continuous state variable and the number</span></span>
<span id="cb6-2"><a href="#cb6-2" aria-hidden="true" tabindex="-1"></a><span class="co"># of meshpoints for the midpoint rule integration. We&#39;ll also create the initial</span></span>
<span id="cb6-3"><a href="#cb6-3" aria-hidden="true" tabindex="-1"></a><span class="co"># population vector from a random uniform distribution</span></span>
<span id="cb6-4"><a href="#cb6-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-5"><a href="#cb6-5" aria-hidden="true" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="fl">1.02</span></span>
<span id="cb6-6"><a href="#cb6-6" aria-hidden="true" tabindex="-1"></a>U <span class="ot">&lt;-</span> <span class="dv">624</span></span>
<span id="cb6-7"><a href="#cb6-7" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb6-8"><a href="#cb6-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-9"><a href="#cb6-9" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2312</span>)</span>
<span id="cb6-10"><a href="#cb6-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-11"><a href="#cb6-11" aria-hidden="true" tabindex="-1"></a>init_pop_vec   <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">500</span>)</span>
<span id="cb6-12"><a href="#cb6-12" aria-hidden="true" tabindex="-1"></a>init_seed_bank <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb6-13"><a href="#cb6-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-14"><a href="#cb6-14" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-15"><a href="#cb6-15" aria-hidden="true" tabindex="-1"></a>general_ipm <span class="ot">&lt;-</span> general_ipm <span class="sc">%&gt;%</span></span>
<span id="cb6-16"><a href="#cb6-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_domains</span>(</span>
<span id="cb6-17"><a href="#cb6-17" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-18"><a href="#cb6-18" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We can pass the variables we created above into define_domains</span></span>
<span id="cb6-19"><a href="#cb6-19" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-20"><a href="#cb6-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">ht =</span> <span class="fu">c</span>(L, U, n)</span>
<span id="cb6-21"><a href="#cb6-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-22"><a href="#cb6-22" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb6-23"><a href="#cb6-23" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_pop_state</span>(</span>
<span id="cb6-24"><a href="#cb6-24" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-25"><a href="#cb6-25" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We can also pass them into define_pop_state</span></span>
<span id="cb6-26"><a href="#cb6-26" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb6-27"><a href="#cb6-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_vectors =</span> <span class="fu">list</span>(</span>
<span id="cb6-28"><a href="#cb6-28" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_ht =</span> init_pop_vec,</span>
<span id="cb6-29"><a href="#cb6-29" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_b  =</span> init_seed_bank</span>
<span id="cb6-30"><a href="#cb6-30" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb6-31"><a href="#cb6-31" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb6-32"><a href="#cb6-32" aria-hidden="true" tabindex="-1"></a>  <span class="fu">make_ipm</span>(<span class="at">iterations =</span> <span class="dv">100</span>,</span>
<span id="cb6-33"><a href="#cb6-33" aria-hidden="true" tabindex="-1"></a>           <span class="at">usr_funs =</span> <span class="fu">list</span>(<span class="at">inv_logit   =</span> inv_logit,</span>
<span id="cb6-34"><a href="#cb6-34" aria-hidden="true" tabindex="-1"></a>                           <span class="at">inv_logit_2 =</span> inv_logit_2))</span>
<span id="cb6-35"><a href="#cb6-35" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-36"><a href="#cb6-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-37"><a href="#cb6-37" aria-hidden="true" tabindex="-1"></a><span class="co"># lambda is a generic function to compute per-capita growth rates. It has a number</span></span>
<span id="cb6-38"><a href="#cb6-38" aria-hidden="true" tabindex="-1"></a><span class="co"># of different options depending on the type of model</span></span>
<span id="cb6-39"><a href="#cb6-39" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-40"><a href="#cb6-40" aria-hidden="true" tabindex="-1"></a><span class="fu">lambda</span>(general_ipm)</span>
<span id="cb6-41"><a href="#cb6-41" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-42"><a href="#cb6-42" aria-hidden="true" tabindex="-1"></a><span class="co"># If we are worried about whether or not the model converged to stable</span></span>
<span id="cb6-43"><a href="#cb6-43" aria-hidden="true" tabindex="-1"></a><span class="co"># dynamics, we can use the exported utility is_conv_to_asymptotic. The default</span></span>
<span id="cb6-44"><a href="#cb6-44" aria-hidden="true" tabindex="-1"></a><span class="co"># tolerance for convergence is 1e-10, but can be changed with the &#39;tol&#39; argument.</span></span>
<span id="cb6-45"><a href="#cb6-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-46"><a href="#cb6-46" aria-hidden="true" tabindex="-1"></a><span class="fu">is_conv_to_asymptotic</span>(general_ipm, <span class="at">tol =</span> <span class="fl">1e-10</span>)</span>
<span id="cb6-47"><a href="#cb6-47" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb6-48"><a href="#cb6-48" aria-hidden="true" tabindex="-1"></a>w <span class="ot">&lt;-</span> <span class="fu">right_ev</span>(general_ipm)</span>
<span id="cb6-49"><a href="#cb6-49" aria-hidden="true" tabindex="-1"></a>v <span class="ot">&lt;-</span> <span class="fu">left_ev</span>(general_ipm)</span></code></pre></div>
<p>Our model is now built! We can explore the asymptotic population growth rate with the <code>lambda()</code> function, which will work on any object made my <code>make_ipm()</code>. The same is true for <code>is_conv_to_asymptotic()</code>, which is a helper to function to figure out if we’ve set the number of <code>iterations</code> high enough to actually reach asymptotic population dynamics. <code>left_ev</code> and <code>right_ev</code> work for general deterministic IPMs as well. Stochastic versions are in the works, but are not yet implemented.</p>
</div>
<div id="further-analysis" class="section level3">
<h3>Further analysis</h3>
<p>Say we wanted to calculate the mean and variance of life span conditional on initial state <span class="math inline">\(z_0\)</span>. This requires us to generate the IPM’s fundamental operator, <span class="math inline">\(N\)</span>, which is computed as follows: <span class="math inline">\(N = (I - P)^{-1}\)</span>. The following chunk is a function to compute average lifespan as a function of initial size. Note that we omit the fecundity from these calculations entirely, as our model does not assume that reproduction imposes a cost on survival.</p>
<p>The formula for mean lifespan is given as <span class="math inline">\(\bar{\eta}(z_0) = eN\)</span> (where <span class="math inline">\(e\)</span> is a constant function such that <span class="math inline">\(e(z)\equiv1\)</span>), and the formula for its variance is <span class="math inline">\(\sigma^2_\eta(z_0) = e(2N^2-N) - (eN)^2\)</span>. Since the <span class="math inline">\(e\)</span> function has the effect of summing columns, we’ll replace that with the <em>R</em> function <code>colSums</code>. Our second function, <code>sigma_eta</code>, will make use of <code>%^%</code> from <code>ipmr</code>, which multiples matrices by themselves, rather than the point-wise power provided by <code>^</code>. More details on the math underlying these calculations are provided in Ellner, Childs, &amp; Rees (2016), chapter 3.</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" aria-hidden="true" tabindex="-1"></a>make_N <span class="ot">&lt;-</span> <span class="cf">function</span>(ipm) {</span>
<span id="cb7-2"><a href="#cb7-2" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-3"><a href="#cb7-3" aria-hidden="true" tabindex="-1"></a>  P     <span class="ot">&lt;-</span> ipm<span class="sc">$</span>sub_kernels<span class="sc">$</span>P</span>
<span id="cb7-4"><a href="#cb7-4" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-5"><a href="#cb7-5" aria-hidden="true" tabindex="-1"></a>  I     <span class="ot">&lt;-</span> <span class="fu">diag</span>(<span class="fu">nrow</span>(P))</span>
<span id="cb7-6"><a href="#cb7-6" aria-hidden="true" tabindex="-1"></a>  N     <span class="ot">&lt;-</span> <span class="fu">solve</span>(I <span class="sc">-</span> P)</span>
<span id="cb7-7"><a href="#cb7-7" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-8"><a href="#cb7-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(N)</span>
<span id="cb7-9"><a href="#cb7-9" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-10"><a href="#cb7-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-11"><a href="#cb7-11" aria-hidden="true" tabindex="-1"></a>eta_bar <span class="ot">&lt;-</span> <span class="cf">function</span>(ipm) {</span>
<span id="cb7-12"><a href="#cb7-12" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-13"><a href="#cb7-13" aria-hidden="true" tabindex="-1"></a>  N     <span class="ot">&lt;-</span> <span class="fu">make_N</span>(ipm)</span>
<span id="cb7-14"><a href="#cb7-14" aria-hidden="true" tabindex="-1"></a>  out   <span class="ot">&lt;-</span> <span class="fu">colSums</span>(N)</span>
<span id="cb7-15"><a href="#cb7-15" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-16"><a href="#cb7-16" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.vector</span>(out))</span>
<span id="cb7-17"><a href="#cb7-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-18"><a href="#cb7-18" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-19"><a href="#cb7-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-20"><a href="#cb7-20" aria-hidden="true" tabindex="-1"></a>sigma_eta <span class="ot">&lt;-</span> <span class="cf">function</span>(ipm) {</span>
<span id="cb7-21"><a href="#cb7-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-22"><a href="#cb7-22" aria-hidden="true" tabindex="-1"></a>  N     <span class="ot">&lt;-</span> <span class="fu">make_N</span>(ipm)  </span>
<span id="cb7-23"><a href="#cb7-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-24"><a href="#cb7-24" aria-hidden="true" tabindex="-1"></a>  out <span class="ot">&lt;-</span> <span class="fu">colSums</span>(<span class="dv">2</span> <span class="sc">*</span> (N <span class="sc">%^%</span> 2L) <span class="sc">-</span> N) <span class="sc">-</span> <span class="fu">colSums</span>(N) <span class="sc">^</span> <span class="dv">2</span></span>
<span id="cb7-25"><a href="#cb7-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb7-26"><a href="#cb7-26" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(<span class="fu">as.vector</span>(out))</span>
<span id="cb7-27"><a href="#cb7-27" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb7-28"><a href="#cb7-28" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-29"><a href="#cb7-29" aria-hidden="true" tabindex="-1"></a>mean_l <span class="ot">&lt;-</span> <span class="fu">eta_bar</span>(general_ipm)</span>
<span id="cb7-30"><a href="#cb7-30" aria-hidden="true" tabindex="-1"></a>var_l  <span class="ot">&lt;-</span> <span class="fu">sigma_eta</span>(general_ipm)</span>
<span id="cb7-31"><a href="#cb7-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-32"><a href="#cb7-32" aria-hidden="true" tabindex="-1"></a>mesh_ps <span class="ot">&lt;-</span> <span class="fu">int_mesh</span>(general_ipm)<span class="sc">$</span>ht_1 <span class="sc">%&gt;%</span></span>
<span id="cb7-33"><a href="#cb7-33" aria-hidden="true" tabindex="-1"></a>  <span class="fu">unique</span>()</span>
<span id="cb7-34"><a href="#cb7-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-35"><a href="#cb7-35" aria-hidden="true" tabindex="-1"></a><span class="fu">par</span>(<span class="at">mfrow =</span> <span class="fu">c</span>(<span class="dv">1</span>,<span class="dv">2</span>))</span>
<span id="cb7-36"><a href="#cb7-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb7-37"><a href="#cb7-37" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mesh_ps, mean_l, <span class="at">type =</span> <span class="st">&quot;l&quot;</span>, <span class="at">xlab =</span> <span class="fu">expression</span>( <span class="st">&quot;Initial size z&quot;</span>[<span class="dv">0</span>]))</span>
<span id="cb7-38"><a href="#cb7-38" aria-hidden="true" tabindex="-1"></a><span class="fu">plot</span>(mesh_ps, var_l, <span class="at">type =</span> <span class="st">&quot;l&quot;</span>, <span class="at">xlab =</span> <span class="fu">expression</span>( <span class="st">&quot;Initial size z&quot;</span>[<span class="dv">0</span>]))</span></code></pre></div>
<p>From prior knowledge, we happen to know that even in the best conditions, <em>Ligustrum obtusifolium</em> individuals usually only live 25-50 years. It appears that our model (wildly) overestimates their average lifespan, and we’d want to think about how to re-parameterize it to more accurately capture mortality events. Our survival model would seem the most likely candidate for re-examination, particularly for young and mid-sized trees. That is a problem for another day though, and so the next section will investigate how to implement general IPMs in discretely varying environments.</p>
</div>
</div>
<div id="general-models-for-discretely-varying-environments" class="section level2">
<h2>General models for discretely varying environments</h2>
<p>Discretely varying parameters can be used to construct general IPMs with little additional effort. These are typically the result of fitting a set of fixed effects vital rate models that include both continuous predictors for size/state and categorical variables like treatment or maturation state. They can also result from mixed effects models, for example, working with conditional modes for a random intercept corresponding to year or site.</p>
<p><code>ipmr</code> refers to these as <em>parameter sets</em>, and abbreviates them <code>par_sets</code>. For example, a random intercept for year may be denoted <span class="math inline">\(\alpha_{yr}\)</span>, where <span class="math inline">\(_{yr}\)</span> provides an index for the different values that <span class="math inline">\(\alpha\)</span> can take on.</p>
<p>If you’ve already read the Intro to <code>ipmr</code> article and the example above, then there aren’t any new concepts to introduce here. Below is an example showing how all of these come together.</p>
<div id="mathematical-overview-of-the-example-1" class="section level3">
<h3>Mathematical overview of the example</h3>
<p>We’ll use a variation of the model above, simulating some random year-specific intercepts for growth and seed production. Parameters, functions, and kernels that are now time varying have a subscript <span class="math inline">\(x_{yr}\)</span> appended to them.</p>
<ol style="list-style-type: decimal">
<li><p><span class="math inline">\(n(z&#39;, t + 1) = \int_L^U P_{yr}(z&#39;, z) n(z,t)d\mathrm{z} + b(t) * \int_L^U leave\_discrete(z&#39;) \mathrm{dz&#39;}\)</span></p></li>
<li><p><span class="math inline">\(b(t + 1) = \int_L^Ugo\_discrete_{yr}(z) n(z,t)d\mathrm{z}+ stay\_discrete\)</span></p></li>
<li><p><span class="math inline">\(P_{yr}(z&#39;,z) = s(z) * G_{yr}(z&#39;,z)\)</span></p></li>
<li><p><span class="math inline">\(go\_discrete_{yr}(z) = r_{s,yr}(z) * r_r(z) * g_i\)</span></p></li>
<li><p><span class="math inline">\(leave\_discrete(z&#39;) = e_p * r_d(z&#39;)\)</span></p></li>
<li><p><span class="math inline">\(stay\_discrete = 0\)</span></p></li>
</ol>
<p>The vital rate models are as follows:</p>
<ol style="list-style-type: decimal">
<li><p>survival (<code>s</code>): A logistic regression</p>
<ul>
<li><p>Example code: <code>glm(surv ~ ht_1, data = my_surv_data, family = binomial())</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Logit(s(z)) = \alpha_s + \beta_{s,1} * z + \beta_{s,2} * z^2\)</span></p></li>
</ul></li>
<li><p>growth (<code>g</code>): A linear mixed effects regression. <span class="math inline">\(f_G\)</span> denotes a normal probability density function.</p>
<ul>
<li><p>example code: <code>lmer(ht_2 ~ ht_1 + (1 | year), data = grow_data)</code></p></li>
<li><p>Mathematical form:</p>
<ul>
<li><p><span class="math inline">\(\mu_{G,yr} = \alpha_G + \alpha_{G,yr} + \beta_G * z\)</span></p></li>
<li><p><span class="math inline">\(G_{yr}(z&#39;,z) = f_G(z&#39;, \mu_{G,yr}, \sigma_G)\)</span></p></li>
</ul></li>
</ul></li>
<li><p>flowering probability (<code>r_r</code>): A logistic regression</p>
<ul>
<li><p>example code: <code>glm(repro ~ ht_1, data = my_repro_data, family = binomial())</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Logit(r_r(z)) = \alpha_{r_r} + \beta_{r_r} * z\)</span></p></li>
</ul></li>
<li><p>seed production (<code>r_s</code>): A Poisson mixed effects regression</p>
<ul>
<li><p>example code: <code>glmer(seeds ~ ht_1 + (1 | year), data = my_seed_data, family = poisson())</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Log(r_{s,yr}(z)) = \alpha_{r_s} + \alpha_{r_s, yr} + \beta_{r_s} * z\)</span></p></li>
</ul></li>
<li><p>Recruit size distribution (<code>r_d</code>): A normal distribution (<span class="math inline">\(f_{r_d}\)</span>) with mean <code>r_d_mu</code> and standard deviation <code>r_d_sd</code>.</p>
<ul>
<li><p>example code: <code>r_d_mu &lt;- mean(my_recr_data$ht_2, na.rm = TRUE)</code> and <code>r_d_sd &lt;- sd(my_recr_data$ht_2, na.rm = TRUE)</code>.</p></li>
<li><p>Mathematical form: <span class="math inline">\(r_d(z&#39;) = f_{r_d}(z&#39;, \mu_{r_d}, \sigma_{r_d})\)</span></p></li>
</ul></li>
<li><p>germination (<code>g_i</code>) and establishment (<code>e_p</code>) are constants. The code below assumes we have our data in long format (each seed get its own row) and that successful germinations/establishments are coded as 1s, failures are 0s, and seeds we don’t know the fate of for whatever reason are <code>NA</code>s.</p>
<ul>
<li><p>example code: <code>g_i &lt;- mean(my_germ_data, na.rm = TRUE)</code> and <code>e_p &lt;- mean(my_est_data, na.rm = TRUE)</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(g_i = 0.5067, e_p = 0.15\)</span></p></li>
</ul></li>
</ol>
</div>
<div id="model-parameterization" class="section level3">
<h3>Model parameterization</h3>
<p>In the next chunk, we’ll set up the data list with all of our constants and make sure the names are what we want them to be. This example generates intercepts for 5 years of data. This can be altered according to your own needs. Then, we’ll define a couple functions to make the vital rate expressions easier to write.</p>
<p>A key aspect here is setting the names on the time-varying parameters in the <code>data_list</code>. We are using the form <code>&quot;g_int_year&quot;</code>, and substituting the values that <code>&quot;year&quot;</code> can take in for the actual index. These don’t need to be numbers, they can be words, letters, or some combination of the two. For this example, the years will be represented with the values <code>1:5</code>. If we wanted to denote the actual years of the censuses, we could switch <code>1:5</code> to, for example, <code>2002:2006</code>.</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ipmr)</span>
<span id="cb8-2"><a href="#cb8-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-3"><a href="#cb8-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Set up the initial population conditions and parameters</span></span>
<span id="cb8-4"><a href="#cb8-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Here, we are simulating random intercepts for growth</span></span>
<span id="cb8-5"><a href="#cb8-5" aria-hidden="true" tabindex="-1"></a><span class="co"># and seed production, converting them to a list,</span></span>
<span id="cb8-6"><a href="#cb8-6" aria-hidden="true" tabindex="-1"></a><span class="co"># and adding them into the list of constants. Equivalent code</span></span>
<span id="cb8-7"><a href="#cb8-7" aria-hidden="true" tabindex="-1"></a><span class="co"># to produce the output for the output from lmer/glmer</span></span>
<span id="cb8-8"><a href="#cb8-8" aria-hidden="true" tabindex="-1"></a><span class="co"># is in the comments next to each line</span></span>
<span id="cb8-9"><a href="#cb8-9" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-10"><a href="#cb8-10" aria-hidden="true" tabindex="-1"></a>all_g_int   <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="fu">rnorm</span>(<span class="dv">5</span>, <span class="at">mean =</span> <span class="fl">5.781</span>, <span class="at">sd =</span> <span class="fl">0.9</span>)) <span class="co"># as.list(unlist(ranef(my_growth_model)))</span></span>
<span id="cb8-11"><a href="#cb8-11" aria-hidden="true" tabindex="-1"></a>all_r_s_int <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="fu">rnorm</span>(<span class="dv">5</span>, <span class="at">mean =</span> <span class="fl">2.6204</span>, <span class="at">sd =</span> <span class="fl">0.3</span>)) <span class="co"># as.list(unlist(ranef(my_seed_model)))</span></span>
<span id="cb8-12"><a href="#cb8-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-13"><a href="#cb8-13" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-14"><a href="#cb8-14" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(all_g_int)   <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;g_int_&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb8-15"><a href="#cb8-15" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(all_r_s_int) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;r_s_int_&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb8-16"><a href="#cb8-16" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-17"><a href="#cb8-17" aria-hidden="true" tabindex="-1"></a>constant_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb8-18"><a href="#cb8-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_slope   =</span> <span class="fl">0.988</span>,</span>
<span id="cb8-19"><a href="#cb8-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_sd      =</span> <span class="fl">20.55699</span>,</span>
<span id="cb8-20"><a href="#cb8-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_int     =</span> <span class="sc">-</span><span class="fl">0.352</span>,</span>
<span id="cb8-21"><a href="#cb8-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_slope   =</span> <span class="fl">0.122</span>,</span>
<span id="cb8-22"><a href="#cb8-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_slope_2 =</span> <span class="sc">-</span><span class="fl">0.000213</span>,</span>
<span id="cb8-23"><a href="#cb8-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_r_int   =</span> <span class="sc">-</span><span class="fl">11.46</span>,</span>
<span id="cb8-24"><a href="#cb8-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_r_slope =</span> <span class="fl">0.0835</span>,</span>
<span id="cb8-25"><a href="#cb8-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_s_slope =</span> <span class="fl">0.01256</span>,</span>
<span id="cb8-26"><a href="#cb8-26" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_d_mu    =</span> <span class="fl">5.6655</span>,</span>
<span id="cb8-27"><a href="#cb8-27" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_d_sd    =</span> <span class="fl">2.0734</span>,</span>
<span id="cb8-28"><a href="#cb8-28" aria-hidden="true" tabindex="-1"></a>  <span class="at">e_p       =</span> <span class="fl">0.15</span>,</span>
<span id="cb8-29"><a href="#cb8-29" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_i       =</span> <span class="fl">0.5067</span></span>
<span id="cb8-30"><a href="#cb8-30" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb8-31"><a href="#cb8-31" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-32"><a href="#cb8-32" aria-hidden="true" tabindex="-1"></a>all_params <span class="ot">&lt;-</span> <span class="fu">c</span>(constant_list, all_g_int, all_r_s_int)</span>
<span id="cb8-33"><a href="#cb8-33" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-34"><a href="#cb8-34" aria-hidden="true" tabindex="-1"></a><span class="co"># The lower and upper bounds for the continuous state variable and the number</span></span>
<span id="cb8-35"><a href="#cb8-35" aria-hidden="true" tabindex="-1"></a><span class="co"># of meshpoints for the midpoint rule integration.</span></span>
<span id="cb8-36"><a href="#cb8-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-37"><a href="#cb8-37" aria-hidden="true" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="fl">1.02</span></span>
<span id="cb8-38"><a href="#cb8-38" aria-hidden="true" tabindex="-1"></a>U <span class="ot">&lt;-</span> <span class="dv">624</span></span>
<span id="cb8-39"><a href="#cb8-39" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb8-40"><a href="#cb8-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-41"><a href="#cb8-41" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2312</span>)</span>
<span id="cb8-42"><a href="#cb8-42" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-43"><a href="#cb8-43" aria-hidden="true" tabindex="-1"></a>init_pop_vec   <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">500</span>)</span>
<span id="cb8-44"><a href="#cb8-44" aria-hidden="true" tabindex="-1"></a>init_seed_bank <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb8-45"><a href="#cb8-45" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-46"><a href="#cb8-46" aria-hidden="true" tabindex="-1"></a><span class="co"># add some helper functions. The survival function</span></span>
<span id="cb8-47"><a href="#cb8-47" aria-hidden="true" tabindex="-1"></a><span class="co"># in this model is a quadratic function, so we use an additional inverse logit function</span></span>
<span id="cb8-48"><a href="#cb8-48" aria-hidden="true" tabindex="-1"></a><span class="co"># that can handle the quadratic term.</span></span>
<span id="cb8-49"><a href="#cb8-49" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-50"><a href="#cb8-50" aria-hidden="true" tabindex="-1"></a>inv_logit <span class="ot">&lt;-</span> <span class="cf">function</span>(int, slope, sv) {</span>
<span id="cb8-51"><a href="#cb8-51" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>(int <span class="sc">+</span> slope <span class="sc">*</span> sv)))</span>
<span id="cb8-52"><a href="#cb8-52" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb8-53"><a href="#cb8-53" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb8-54"><a href="#cb8-54" aria-hidden="true" tabindex="-1"></a>inv_logit_2 <span class="ot">&lt;-</span> <span class="cf">function</span>(int, slope, slope_2, sv) {</span>
<span id="cb8-55"><a href="#cb8-55" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>(int <span class="sc">+</span> slope <span class="sc">*</span> sv <span class="sc">+</span> slope_2 <span class="sc">*</span> sv <span class="sc">^</span> <span class="dv">2</span>)))</span>
<span id="cb8-56"><a href="#cb8-56" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
<p>Next, we will set up our sub-kernels. We’ll append the <code>_year</code> suffix to the kernel <code>name</code>, the vital rate expressions and parameter values that have time-varying components (<code>g_year</code>, <code>f_s_year</code>, <code>g_int_year</code>, <code>f_s_int_year</code>), and the call to <code>truncated_distributions</code> so that the growth kernel is correctly specified. We’ll also pass a <code>list(year = 1:5))</code> into the <code>par_set_indices</code> argument of <code>define_kernel()</code>. When building the model, <code>make_ipm()</code> automatically expands these expressions to create 5 different expressions containing the various levels of <code>year</code>.</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" aria-hidden="true" tabindex="-1"></a>general_stoch_kern_ipm <span class="ot">&lt;-</span> <span class="fu">init_ipm</span>(<span class="at">sim_gen    =</span> <span class="st">&quot;general&quot;</span>,</span>
<span id="cb9-2"><a href="#cb9-2" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">di_dd      =</span> <span class="st">&quot;di&quot;</span>, </span>
<span id="cb9-3"><a href="#cb9-3" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">det_stoch  =</span> <span class="st">&quot;stoch&quot;</span>,</span>
<span id="cb9-4"><a href="#cb9-4" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">kern_param =</span> <span class="st">&quot;kern&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb9-5"><a href="#cb9-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb9-6"><a href="#cb9-6" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-7"><a href="#cb9-7" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The kernel name gets indexed by _year to denote that there</span></span>
<span id="cb9-8"><a href="#cb9-8" aria-hidden="true" tabindex="-1"></a>    <span class="co"># are multiple possible kernels we can build with our parameter set.</span></span>
<span id="cb9-9"><a href="#cb9-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># The _year gets substituted by the values in &quot;par_set_indices&quot; in the </span></span>
<span id="cb9-10"><a href="#cb9-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># output, so in this example we will have P_1, P_2, P_3, P_4, and P_5</span></span>
<span id="cb9-11"><a href="#cb9-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-12"><a href="#cb9-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">name          =</span> <span class="st">&quot;P_year&quot;</span>,</span>
<span id="cb9-13"><a href="#cb9-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-14"><a href="#cb9-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We also add _year to &quot;g&quot; to signify that it is going to vary across kernels.</span></span>
<span id="cb9-15"><a href="#cb9-15" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-16"><a href="#cb9-16" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> s <span class="sc">*</span> g_year <span class="sc">*</span> d_ht,</span>
<span id="cb9-17"><a href="#cb9-17" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&quot;CC&quot;</span>,</span>
<span id="cb9-18"><a href="#cb9-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-19"><a href="#cb9-19" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Here, we add the suffixes again, ensuring they are expanded and replaced</span></span>
<span id="cb9-20"><a href="#cb9-20" aria-hidden="true" tabindex="-1"></a>    <span class="co"># during model building by the parameter names</span></span>
<span id="cb9-21"><a href="#cb9-21" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-22"><a href="#cb9-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">g_year           =</span> <span class="fu">dnorm</span>(ht_2, g_mu_year, g_sd),</span>
<span id="cb9-23"><a href="#cb9-23" aria-hidden="true" tabindex="-1"></a>    <span class="at">g_mu_year        =</span> g_int_year <span class="sc">+</span> g_slope <span class="sc">*</span> ht_1,</span>
<span id="cb9-24"><a href="#cb9-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">s                =</span> <span class="fu">inv_logit_2</span>(s_int, s_slope, s_slope_2, ht_1),</span>
<span id="cb9-25"><a href="#cb9-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list        =</span> all_params,</span>
<span id="cb9-26"><a href="#cb9-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">states           =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>)),</span>
<span id="cb9-27"><a href="#cb9-27" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-28"><a href="#cb9-28" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We set uses_par_sets to TRUE, signalling that we want to expand these</span></span>
<span id="cb9-29"><a href="#cb9-29" aria-hidden="true" tabindex="-1"></a>    <span class="co"># expressions across all levels of par_set_indices.</span></span>
<span id="cb9-30"><a href="#cb9-30" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-31"><a href="#cb9-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets    =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-32"><a href="#cb9-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">par_set_indices =</span> <span class="fu">list</span>(<span class="at">year =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>),</span>
<span id="cb9-33"><a href="#cb9-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor        =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-34"><a href="#cb9-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-35"><a href="#cb9-35" aria-hidden="true" tabindex="-1"></a>    <span class="co"># we also add the suffix to `target` here, because the value modified by </span></span>
<span id="cb9-36"><a href="#cb9-36" aria-hidden="true" tabindex="-1"></a>    <span class="co"># truncated_distributions is time-varying.</span></span>
<span id="cb9-37"><a href="#cb9-37" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-38"><a href="#cb9-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_fun        =</span> <span class="fu">truncated_distributions</span>(<span class="st">&#39;norm&#39;</span>,</span>
<span id="cb9-39"><a href="#cb9-39" aria-hidden="true" tabindex="-1"></a>                                               <span class="at">target =</span> <span class="st">&#39;g_year&#39;</span>)</span>
<span id="cb9-40"><a href="#cb9-40" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb9-41"><a href="#cb9-41" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb9-42"><a href="#cb9-42" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-43"><a href="#cb9-43" aria-hidden="true" tabindex="-1"></a>    <span class="co"># again, we append the index to the kernel name, vital rate expressions,</span></span>
<span id="cb9-44"><a href="#cb9-44" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and in the model formula.</span></span>
<span id="cb9-45"><a href="#cb9-45" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-46"><a href="#cb9-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">name          =</span> <span class="st">&quot;go_discrete_year&quot;</span>,</span>
<span id="cb9-47"><a href="#cb9-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> r_r <span class="sc">*</span> r_s_year <span class="sc">*</span> g_i <span class="sc">*</span> d_ht,</span>
<span id="cb9-48"><a href="#cb9-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&#39;CD&#39;</span>,</span>
<span id="cb9-49"><a href="#cb9-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">r_r           =</span> <span class="fu">inv_logit</span>(r_r_int, r_r_slope, ht_1),</span>
<span id="cb9-50"><a href="#cb9-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-51"><a href="#cb9-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Again, we modify the left and right hand side of this expression to </span></span>
<span id="cb9-52"><a href="#cb9-52" aria-hidden="true" tabindex="-1"></a>    <span class="co"># show that there is a time-varying component</span></span>
<span id="cb9-53"><a href="#cb9-53" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-54"><a href="#cb9-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">r_s_year      =</span> <span class="fu">exp</span>(r_s_int_year <span class="sc">+</span> r_s_slope <span class="sc">*</span> ht_1),</span>
<span id="cb9-55"><a href="#cb9-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list     =</span> all_params,</span>
<span id="cb9-56"><a href="#cb9-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">states        =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>, <span class="st">&quot;b&quot;</span>)),</span>
<span id="cb9-57"><a href="#cb9-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets    =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-58"><a href="#cb9-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">par_set_indices =</span> <span class="fu">list</span>(<span class="at">year =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb9-59"><a href="#cb9-59" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb9-60"><a href="#cb9-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb9-61"><a href="#cb9-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-62"><a href="#cb9-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This kernel has no time-varying parameters, and so is not indexed.</span></span>
<span id="cb9-63"><a href="#cb9-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-64"><a href="#cb9-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">name    =</span> <span class="st">&#39;stay_discrete&#39;</span>,</span>
<span id="cb9-65"><a href="#cb9-65" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-66"><a href="#cb9-66" aria-hidden="true" tabindex="-1"></a>    <span class="co"># In this case, seeds in the seed bank either germinate or die, but they </span></span>
<span id="cb9-67"><a href="#cb9-67" aria-hidden="true" tabindex="-1"></a>    <span class="co"># do not remain for multipe time steps. This can be adjusted as needed.</span></span>
<span id="cb9-68"><a href="#cb9-68" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-69"><a href="#cb9-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="dv">0</span>,</span>
<span id="cb9-70"><a href="#cb9-70" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-71"><a href="#cb9-71" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Note that now, family = &quot;DD&quot; becuase it denotes a discrete -&gt; discrete transition</span></span>
<span id="cb9-72"><a href="#cb9-72" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-73"><a href="#cb9-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">family  =</span> <span class="st">&quot;DD&quot;</span>,</span>
<span id="cb9-74"><a href="#cb9-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">states  =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;b&#39;</span>)),</span>
<span id="cb9-75"><a href="#cb9-75" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-76"><a href="#cb9-76" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This kernel has no time-varying parameters, so we don&#39;t need to designate</span></span>
<span id="cb9-77"><a href="#cb9-77" aria-hidden="true" tabindex="-1"></a>    <span class="co"># it as such.</span></span>
<span id="cb9-78"><a href="#cb9-78" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-79"><a href="#cb9-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-80"><a href="#cb9-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor =</span> <span class="cn">FALSE</span></span>
<span id="cb9-81"><a href="#cb9-81" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb9-82"><a href="#cb9-82" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb9-83"><a href="#cb9-83" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb9-84"><a href="#cb9-84" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This kernel also doesn&#39;t get a index, because there are no varying parameters.</span></span>
<span id="cb9-85"><a href="#cb9-85" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-86"><a href="#cb9-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">name          =</span> <span class="st">&#39;leave_discrete&#39;</span>,</span>
<span id="cb9-87"><a href="#cb9-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> e_p <span class="sc">*</span> r_d <span class="sc">*</span> d_ht,</span>
<span id="cb9-88"><a href="#cb9-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">r_d           =</span> <span class="fu">dnorm</span>(ht_2, r_d_mu, r_d_sd),</span>
<span id="cb9-89"><a href="#cb9-89" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&#39;DC&#39;</span>,</span>
<span id="cb9-90"><a href="#cb9-90" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list     =</span> all_params,</span>
<span id="cb9-91"><a href="#cb9-91" aria-hidden="true" tabindex="-1"></a>    <span class="at">states        =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>, <span class="st">&quot;b&quot;</span>)),</span>
<span id="cb9-92"><a href="#cb9-92" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets =</span> <span class="cn">FALSE</span>,</span>
<span id="cb9-93"><a href="#cb9-93" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor     =</span> <span class="cn">TRUE</span>,</span>
<span id="cb9-94"><a href="#cb9-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_fun     =</span> <span class="fu">truncated_distributions</span>(<span class="st">&#39;norm&#39;</span>,</span>
<span id="cb9-95"><a href="#cb9-95" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">&#39;r_d&#39;</span>)</span>
<span id="cb9-96"><a href="#cb9-96" aria-hidden="true" tabindex="-1"></a>  )  <span class="sc">%&gt;%</span></span>
<span id="cb9-97"><a href="#cb9-97" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_impl</span>(</span>
<span id="cb9-98"><a href="#cb9-98" aria-hidden="true" tabindex="-1"></a>    <span class="fu">make_impl_args_list</span>(</span>
<span id="cb9-99"><a href="#cb9-99" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-100"><a href="#cb9-100" aria-hidden="true" tabindex="-1"></a>      <span class="co"># We add suffixes to the kernel names here to make sure they match the names</span></span>
<span id="cb9-101"><a href="#cb9-101" aria-hidden="true" tabindex="-1"></a>      <span class="co"># we specified above.</span></span>
<span id="cb9-102"><a href="#cb9-102" aria-hidden="true" tabindex="-1"></a>      </span>
<span id="cb9-103"><a href="#cb9-103" aria-hidden="true" tabindex="-1"></a>      <span class="at">kernel_names =</span> <span class="fu">c</span>(<span class="st">&quot;P_year&quot;</span>, <span class="st">&quot;go_discrete_year&quot;</span>, <span class="st">&quot;stay_discrete&quot;</span>, <span class="st">&quot;leave_discrete&quot;</span>),</span>
<span id="cb9-104"><a href="#cb9-104" aria-hidden="true" tabindex="-1"></a>      <span class="at">int_rule     =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&quot;midpoint&quot;</span>, <span class="dv">4</span>)),</span>
<span id="cb9-105"><a href="#cb9-105" aria-hidden="true" tabindex="-1"></a>      <span class="at">state_start    =</span> <span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>, <span class="st">&quot;ht&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;b&quot;</span>),</span>
<span id="cb9-106"><a href="#cb9-106" aria-hidden="true" tabindex="-1"></a>      <span class="at">state_end      =</span> <span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&#39;ht&#39;</span>)</span>
<span id="cb9-107"><a href="#cb9-107" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb9-108"><a href="#cb9-108" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb9-109"><a href="#cb9-109" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_domains</span>(</span>
<span id="cb9-110"><a href="#cb9-110" aria-hidden="true" tabindex="-1"></a>    <span class="at">ht =</span> <span class="fu">c</span>(L, U, n)</span>
<span id="cb9-111"><a href="#cb9-111" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb9-112"><a href="#cb9-112" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_pop_state</span>(</span>
<span id="cb9-113"><a href="#cb9-113" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_ht =</span> init_pop_vec,</span>
<span id="cb9-114"><a href="#cb9-114" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_b  =</span> init_seed_bank</span>
<span id="cb9-115"><a href="#cb9-115" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb9-116"><a href="#cb9-116" aria-hidden="true" tabindex="-1"></a>  <span class="fu">make_ipm</span>(</span>
<span id="cb9-117"><a href="#cb9-117" aria-hidden="true" tabindex="-1"></a>    <span class="at">iterations =</span> <span class="dv">100</span>,</span>
<span id="cb9-118"><a href="#cb9-118" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-119"><a href="#cb9-119" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We can specify a sequence of kernels to select for the simulation.</span></span>
<span id="cb9-120"><a href="#cb9-120" aria-hidden="true" tabindex="-1"></a>    <span class="co"># This helps others to reproduce what we did,</span></span>
<span id="cb9-121"><a href="#cb9-121" aria-hidden="true" tabindex="-1"></a>    <span class="co"># and lets us keep track of the consequences of different selection</span></span>
<span id="cb9-122"><a href="#cb9-122" aria-hidden="true" tabindex="-1"></a>    <span class="co"># sequences for population dynamics. </span></span>
<span id="cb9-123"><a href="#cb9-123" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb9-124"><a href="#cb9-124" aria-hidden="true" tabindex="-1"></a>    <span class="at">kernel_seq =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">size =</span> <span class="dv">100</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb9-125"><a href="#cb9-125" aria-hidden="true" tabindex="-1"></a>    <span class="at">usr_funs =</span> <span class="fu">list</span>(<span class="at">inv_logit   =</span> inv_logit,</span>
<span id="cb9-126"><a href="#cb9-126" aria-hidden="true" tabindex="-1"></a>                    <span class="at">inv_logit_2 =</span> inv_logit_2)</span>
<span id="cb9-127"><a href="#cb9-127" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>100 isn’t too many iterations, but hopefully this demonstrates how to set up and implement such a model. There are a number of slots in the output that may be useful for further analyses.</p>
<ol style="list-style-type: decimal">
<li><p><code>env_seq</code>: This contains a character vector which shows the sequence in which levels of the time-varying components were chosen during model iteration. We could use this reproduce the model outputs later.</p></li>
<li><p><code>pop_state$lambda</code>: This shows the single timestep per-capita growth rates for the simulation.</p></li>
</ol>
<p>Additionally, there are functions to compute the stochastic population growth rate (<span class="math inline">\(\lambda_s\)</span>, computed as <code>mean(log(pop_state$lambda))</code>, burn in can be controlled with the <code>burn_in</code> parameter), and the mean sub-kernels.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a>mean_kernels <span class="ot">&lt;-</span> <span class="fu">mean_kernel</span>(general_stoch_kern_ipm)</span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>lam_s        <span class="ot">&lt;-</span> <span class="fu">lambda</span>(general_stoch_kern_ipm, <span class="at">burn_in =</span> <span class="fl">0.15</span>) <span class="co"># Remove first 15% of iterations</span></span></code></pre></div>
</div>
</div>
<div id="general-models-with-continuously-varying-environments" class="section level2">
<h2>General models with continuously varying environments</h2>
<p>We can also use continuously varying parameters to construct general IPMs. These are good tools for exploring the consequences of environmental variation on demographic rates. <code>ipmr</code> handles these using <code>define_env_state()</code>, which can take both functions and data and generate draws from distributions during each iteration of the model.</p>
<div id="mathematical-overview" class="section level3">
<h3>Mathematical overview</h3>
<p>This example includes survival and growth models that make use of environmental covariates. The model can be written as:</p>
<ol style="list-style-type: decimal">
<li><p><span class="math inline">\(n(z&#39;, t+1) = \int_L^U K(z&#39;,z, \theta)n(z,t)dz + B(t) * r_s * r_d * \int_L^Uf_{c_d}(z&#39;)dz&#39;\)</span></p></li>
<li><p><span class="math inline">\(B(t + 1) = r_e * r_s * \int_L^U c_r(z) * c_s(z)n(z,t)dz + B(t) * r_s * r_r\)</span></p></li>
<li><p><span class="math inline">\(K(z&#39;,z,\theta) = P(z&#39;,z,\theta) + F(z&#39;,z)\)</span></p></li>
<li><p><span class="math inline">\(P(z&#39;,z,\theta) = s(z, \theta) * G(z&#39;,z,\theta)\)</span></p></li>
<li><p><span class="math inline">\(F(z&#39;,z) = c_r(z) * c_s(z) * c_d(z&#39;) * (1 - r_e)\)</span></p></li>
</ol>
<p><span class="math inline">\(\theta\)</span> is a vector of time-varying environmental parameters. For this example, we’ll use a Gaussian distribution for temperature and a Gamma distribution for precipitation:</p>
<ol start="6" style="list-style-type: decimal">
<li><p><span class="math inline">\(\theta_t \sim Norm(\mu = 8.9, \sigma = 1.2)\)</span></p></li>
<li><p><span class="math inline">\(\theta_p \sim Gamma(k = 1000, \beta = 2)\)</span></p></li>
</ol>
<p>Next, we’ll write out the actual vital rate functions in the model:</p>
<ol start="8" style="list-style-type: decimal">
<li><p>survival (<code>s</code>/<span class="math inline">\(s(z,\theta)\)</span>): a logistic regression.</p>
<ul>
<li><p>Example model formula: <code>glm(survival ~ size_1 + temp + precip, data = my_surv_data, family = binomial())</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Logit(s(z,\theta)) = \alpha_s + \beta_s^z * z + \beta_s^t * temp + \beta_s^p * precip\)</span></p></li>
</ul></li>
<li><p>growth (<code>g</code>, <span class="math inline">\(G(z&#39;,z,\theta)\)</span>): a linear regression with a Normal error distribution (denoted <span class="math inline">\(f_G\)</span>)</p>
<ul>
<li><p>Example model formula: <code>glm(size_2 ~ size_1 + temp + precip, data = my_grow_data)</code></p></li>
<li><p>Mathematical form:</p>
<ul>
<li><p><span class="math inline">\(G(z&#39;,z) = f_G(z&#39;, \mu_G(z,\theta), \sigma_G)\)</span></p></li>
<li><p><span class="math inline">\(\mu_G(z, \theta) = \alpha_G + \beta_G^z * z + \beta_G^t * temp + \beta_G^p * precip\)</span></p></li>
</ul></li>
</ul></li>
<li><p>flower probability (<code>c_r</code>/<span class="math inline">\(c_r(z)\)</span>): A logistic regression.</p>
<ul>
<li><p>Example model formula: <code>glm(repro ~ size_1, data = my_repro_data, family = binomial())</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Logit(c_r(z)) = \alpha_{c} + \beta_{c_r} * z\)</span></p></li>
</ul></li>
<li><p>seed production (<code>c_s</code>/<span class="math inline">\(c_s(z)\)</span>: a logistic regression.</p>
<ul>
<li><p>Example model formula: <code>glm(flower_n ~ size_1, data = my_flower_data, family = poisson())</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(Log(c_s(z)) = \alpha_{c_s} + \beta_{c_s} * z\)</span></p></li>
</ul></li>
<li><p>recruit sizes (<code>c_d</code>/<span class="math inline">\(c_d(z&#39;)\)</span>): A Normal distribution (denoted <span class="math inline">\(f_{c_d}\)</span>)</p>
<ul>
<li><p>Example code: mean (<code>c_d_mu</code>) <code>mean(my_recruit_data$size_2, na.rm = TRUE)</code> and standard deviation (<code>c_d_sd</code>) <code>sd(my_recruit_data$size_2, na.rm = TRUE)</code></p></li>
<li><p>Mathematical form: <span class="math inline">\(c_d(z&#39;) = f_{c_d}(z&#39;, \mu_{f_d}, \sigma_{f_d})\)</span></p></li>
</ul></li>
<li><p>Constants: Discrete stage survival (<code>r_s</code>), discrete stage entrance probability (<code>r_e</code>), discrete stage departure probability conditional on survival (<code>r_d</code>), and probability of remaining in discrete stage (<code>r_r</code>).</p></li>
</ol>
</div>
<div id="model-parameterization-1" class="section level3">
<h3>Model parameterization</h3>
<p>First, we’ll specify the constant parameters. We keep all values related to demography in the <code>data_list</code>.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(ipmr)</span>
<span id="cb11-2"><a href="#cb11-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-3"><a href="#cb11-3" aria-hidden="true" tabindex="-1"></a><span class="co"># Define the fixed parameters in a list</span></span>
<span id="cb11-4"><a href="#cb11-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb11-5"><a href="#cb11-5" aria-hidden="true" tabindex="-1"></a>constant_params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb11-6"><a href="#cb11-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_int     =</span> <span class="sc">-</span><span class="dv">5</span>,</span>
<span id="cb11-7"><a href="#cb11-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_slope   =</span> <span class="fl">2.2</span>,</span>
<span id="cb11-8"><a href="#cb11-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_precip  =</span> <span class="fl">0.0002</span>,</span>
<span id="cb11-9"><a href="#cb11-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_temp    =</span> <span class="sc">-</span><span class="fl">0.003</span>,</span>
<span id="cb11-10"><a href="#cb11-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_int     =</span> <span class="fl">0.2</span>,</span>
<span id="cb11-11"><a href="#cb11-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_slope   =</span> <span class="fl">1.01</span>,</span>
<span id="cb11-12"><a href="#cb11-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_sd      =</span> <span class="fl">1.2</span>,</span>
<span id="cb11-13"><a href="#cb11-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_temp    =</span> <span class="sc">-</span><span class="fl">0.002</span>,</span>
<span id="cb11-14"><a href="#cb11-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_precip  =</span> <span class="fl">0.004</span>,</span>
<span id="cb11-15"><a href="#cb11-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">c_r_int   =</span> <span class="fl">0.3</span>,</span>
<span id="cb11-16"><a href="#cb11-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">c_r_slope =</span> <span class="fl">0.03</span>,</span>
<span id="cb11-17"><a href="#cb11-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">c_s_int   =</span> <span class="fl">0.4</span>,</span>
<span id="cb11-18"><a href="#cb11-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">c_s_slope =</span> <span class="fl">0.01</span>,</span>
<span id="cb11-19"><a href="#cb11-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">c_d_mu    =</span> <span class="fl">1.1</span>,</span>
<span id="cb11-20"><a href="#cb11-20" aria-hidden="true" tabindex="-1"></a>  <span class="at">c_d_sd    =</span> <span class="fl">0.1</span>,</span>
<span id="cb11-21"><a href="#cb11-21" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_e       =</span> <span class="fl">0.3</span>,</span>
<span id="cb11-22"><a href="#cb11-22" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_d       =</span> <span class="fl">0.3</span>,</span>
<span id="cb11-23"><a href="#cb11-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_r       =</span> <span class="fl">0.2</span>,</span>
<span id="cb11-24"><a href="#cb11-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_s       =</span> <span class="fl">0.2</span></span>
<span id="cb11-25"><a href="#cb11-25" aria-hidden="true" tabindex="-1"></a>)</span></code></pre></div>
<p>In addition to creating the standard <code>data_list</code>, we need to create a function to sample the environmental covariates, and a list of parameters that generate the environmental covariates. The function needs to return a named list. The names in the returned list can be referenced in vital rate expressions, kernel formulas, etc. as if we had specified them in the <code>data_list</code>. <code>make_ipm()</code> only runs the functions in <code>define_env_state()</code> once per model iteration. This ensures that parameters from joint distributions can be used consistently across kernels without losing user-any specified correlations.</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Now, we create a set of environmental covariates. In this example, we use</span></span>
<span id="cb12-2"><a href="#cb12-2" aria-hidden="true" tabindex="-1"></a><span class="co"># a normal distribution for temperature and a Gamma for precipitation. </span></span>
<span id="cb12-3"><a href="#cb12-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-4"><a href="#cb12-4" aria-hidden="true" tabindex="-1"></a>env_params <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb12-5"><a href="#cb12-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_mu =</span> <span class="fl">8.9</span>,</span>
<span id="cb12-6"><a href="#cb12-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">temp_sd =</span> <span class="fl">1.2</span>,</span>
<span id="cb12-7"><a href="#cb12-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">precip_shape =</span> <span class="dv">1000</span>,</span>
<span id="cb12-8"><a href="#cb12-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">precip_rate  =</span> <span class="dv">2</span></span>
<span id="cb12-9"><a href="#cb12-9" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb12-10"><a href="#cb12-10" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-11"><a href="#cb12-11" aria-hidden="true" tabindex="-1"></a><span class="co"># We define a wrapper function that samples from these distributions</span></span>
<span id="cb12-12"><a href="#cb12-12" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-13"><a href="#cb12-13" aria-hidden="true" tabindex="-1"></a>sample_env <span class="ot">&lt;-</span> <span class="cf">function</span>(env_params) {</span>
<span id="cb12-14"><a href="#cb12-14" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-15"><a href="#cb12-15" aria-hidden="true" tabindex="-1"></a>  <span class="co"># We generate one value for each covariate per iteration, and return it </span></span>
<span id="cb12-16"><a href="#cb12-16" aria-hidden="true" tabindex="-1"></a>  <span class="co"># as a named list. </span></span>
<span id="cb12-17"><a href="#cb12-17" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-18"><a href="#cb12-18" aria-hidden="true" tabindex="-1"></a>  temp_now <span class="ot">&lt;-</span> <span class="fu">rnorm</span>(<span class="dv">1</span>,</span>
<span id="cb12-19"><a href="#cb12-19" aria-hidden="true" tabindex="-1"></a>                    env_params<span class="sc">$</span>temp_mu, </span>
<span id="cb12-20"><a href="#cb12-20" aria-hidden="true" tabindex="-1"></a>                    env_params<span class="sc">$</span>temp_sd)</span>
<span id="cb12-21"><a href="#cb12-21" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-22"><a href="#cb12-22" aria-hidden="true" tabindex="-1"></a>  precip_now <span class="ot">&lt;-</span> <span class="fu">rgamma</span>(<span class="dv">1</span>, </span>
<span id="cb12-23"><a href="#cb12-23" aria-hidden="true" tabindex="-1"></a>                       <span class="at">shape =</span> env_params<span class="sc">$</span>precip_shape,</span>
<span id="cb12-24"><a href="#cb12-24" aria-hidden="true" tabindex="-1"></a>                       <span class="at">rate =</span> env_params<span class="sc">$</span>precip_rate)</span>
<span id="cb12-25"><a href="#cb12-25" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-26"><a href="#cb12-26" aria-hidden="true" tabindex="-1"></a>  <span class="co"># The vital rate expressions can now use the names &quot;temp&quot; and &quot;precip&quot; </span></span>
<span id="cb12-27"><a href="#cb12-27" aria-hidden="true" tabindex="-1"></a>  <span class="co"># as if they were in the data_list.</span></span>
<span id="cb12-28"><a href="#cb12-28" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-29"><a href="#cb12-29" aria-hidden="true" tabindex="-1"></a>  out        <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">temp =</span> temp_now, <span class="at">precip =</span> precip_now)</span>
<span id="cb12-30"><a href="#cb12-30" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-31"><a href="#cb12-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">return</span>(out)</span>
<span id="cb12-32"><a href="#cb12-32" aria-hidden="true" tabindex="-1"></a>  </span>
<span id="cb12-33"><a href="#cb12-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb12-34"><a href="#cb12-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-35"><a href="#cb12-35" aria-hidden="true" tabindex="-1"></a><span class="co"># Again, we can define our own functions and pass them into calls to make_ipm. This</span></span>
<span id="cb12-36"><a href="#cb12-36" aria-hidden="true" tabindex="-1"></a><span class="co"># isn&#39;t strictly necessary, but can make the model code more readable/less error prone.</span></span>
<span id="cb12-37"><a href="#cb12-37" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb12-38"><a href="#cb12-38" aria-hidden="true" tabindex="-1"></a>inv_logit <span class="ot">&lt;-</span> <span class="cf">function</span>(lin_term) {</span>
<span id="cb12-39"><a href="#cb12-39" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>lin_term))</span>
<span id="cb12-40"><a href="#cb12-40" aria-hidden="true" tabindex="-1"></a>}</span></code></pre></div>
</div>
<div id="model-specification" class="section level3">
<h3>Model specification</h3>
<p>We are now ready to begin implementing the model. This next chunk should look familiar, with the caveat that we have now add the terms <code>temp</code> and <code>precip</code> to vital rates in the <code>P</code> kernel.</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" aria-hidden="true" tabindex="-1"></a>general_stoch_param_model <span class="ot">&lt;-</span> <span class="fu">init_ipm</span>(<span class="at">sim_gen    =</span> <span class="st">&quot;general&quot;</span>,</span>
<span id="cb13-2"><a href="#cb13-2" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">di_dd      =</span> <span class="st">&quot;di&quot;</span>, </span>
<span id="cb13-3"><a href="#cb13-3" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">det_stoch  =</span> <span class="st">&quot;stoch&quot;</span>,</span>
<span id="cb13-4"><a href="#cb13-4" aria-hidden="true" tabindex="-1"></a>                                      <span class="at">kern_param =</span> <span class="st">&quot;param&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb13-5"><a href="#cb13-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb13-6"><a href="#cb13-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">name       =</span> <span class="st">&quot;P_stoch&quot;</span>,</span>
<span id="cb13-7"><a href="#cb13-7" aria-hidden="true" tabindex="-1"></a>    <span class="at">family     =</span> <span class="st">&quot;CC&quot;</span>,</span>
<span id="cb13-8"><a href="#cb13-8" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-9"><a href="#cb13-9" aria-hidden="true" tabindex="-1"></a>    <span class="co"># As in the examples above, we have to add the d_surf_area</span></span>
<span id="cb13-10"><a href="#cb13-10" aria-hidden="true" tabindex="-1"></a>    <span class="co"># to ensure the integration of the functions is done.</span></span>
<span id="cb13-11"><a href="#cb13-11" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-12"><a href="#cb13-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula    =</span> s <span class="sc">*</span> g <span class="sc">*</span> d_surf_area,</span>
<span id="cb13-13"><a href="#cb13-13" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-14"><a href="#cb13-14" aria-hidden="true" tabindex="-1"></a>    <span class="co"># We can reference continuously varying parameters by name</span></span>
<span id="cb13-15"><a href="#cb13-15" aria-hidden="true" tabindex="-1"></a>    <span class="co"># in the vital rate expressions just as before, even though</span></span>
<span id="cb13-16"><a href="#cb13-16" aria-hidden="true" tabindex="-1"></a>    <span class="co"># they are passed in define_env_state() as opposed to the kernel&#39;s</span></span>
<span id="cb13-17"><a href="#cb13-17" aria-hidden="true" tabindex="-1"></a>    <span class="co"># data_list</span></span>
<span id="cb13-18"><a href="#cb13-18" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-19"><a href="#cb13-19" aria-hidden="true" tabindex="-1"></a>    <span class="at">g_mu    =</span> g_int <span class="sc">+</span> g_slope <span class="sc">*</span> surf_area_1 <span class="sc">+</span> g_temp <span class="sc">*</span> temp <span class="sc">+</span> g_precip <span class="sc">*</span> precip,</span>
<span id="cb13-20"><a href="#cb13-20" aria-hidden="true" tabindex="-1"></a>    <span class="at">s_lin_p =</span> s_int <span class="sc">+</span> s_slope <span class="sc">*</span> surf_area_1 <span class="sc">+</span> s_temp <span class="sc">*</span> temp <span class="sc">+</span> s_precip <span class="sc">*</span> precip,</span>
<span id="cb13-21"><a href="#cb13-21" aria-hidden="true" tabindex="-1"></a>    <span class="at">s       =</span> <span class="fu">inv_logit</span>(s_lin_p),</span>
<span id="cb13-22"><a href="#cb13-22" aria-hidden="true" tabindex="-1"></a>    <span class="at">g       =</span> <span class="fu">dnorm</span>(surf_area_2, g_mu, g_sd),</span>
<span id="cb13-23"><a href="#cb13-23" aria-hidden="true" tabindex="-1"></a>   </span>
<span id="cb13-24"><a href="#cb13-24" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list     =</span> constant_params,</span>
<span id="cb13-25"><a href="#cb13-25" aria-hidden="true" tabindex="-1"></a>    <span class="at">states        =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&quot;surf_area&quot;</span>)),</span>
<span id="cb13-26"><a href="#cb13-26" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets =</span> <span class="cn">FALSE</span>,</span>
<span id="cb13-27"><a href="#cb13-27" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor     =</span> <span class="cn">TRUE</span>,</span>
<span id="cb13-28"><a href="#cb13-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_fun     =</span> <span class="fu">truncated_distributions</span>(<span class="st">&quot;norm&quot;</span>, <span class="st">&quot;g&quot;</span>)</span>
<span id="cb13-29"><a href="#cb13-29" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-30"><a href="#cb13-30" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb13-31"><a href="#cb13-31" aria-hidden="true" tabindex="-1"></a>    <span class="at">name          =</span> <span class="st">&quot;F&quot;</span>,</span>
<span id="cb13-32"><a href="#cb13-32" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&quot;CC&quot;</span>,</span>
<span id="cb13-33"><a href="#cb13-33" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> c_r <span class="sc">*</span> c_s <span class="sc">*</span> c_d <span class="sc">*</span> (<span class="dv">1</span> <span class="sc">-</span> r_e) <span class="sc">*</span> d_surf_area,</span>
<span id="cb13-34"><a href="#cb13-34" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-35"><a href="#cb13-35" aria-hidden="true" tabindex="-1"></a>    <span class="at">c_r_lin_p     =</span> c_r_int <span class="sc">+</span> c_r_slope <span class="sc">*</span> surf_area_1,</span>
<span id="cb13-36"><a href="#cb13-36" aria-hidden="true" tabindex="-1"></a>    <span class="at">c_r           =</span> <span class="fu">inv_logit</span>(c_r_lin_p),</span>
<span id="cb13-37"><a href="#cb13-37" aria-hidden="true" tabindex="-1"></a>    <span class="at">c_s           =</span> <span class="fu">exp</span>(c_s_int <span class="sc">+</span> c_s_slope <span class="sc">*</span> surf_area_1),</span>
<span id="cb13-38"><a href="#cb13-38" aria-hidden="true" tabindex="-1"></a>    <span class="at">c_d           =</span> <span class="fu">dnorm</span>(surf_area_2, c_d_mu, c_d_sd),</span>
<span id="cb13-39"><a href="#cb13-39" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list     =</span> constant_params,</span>
<span id="cb13-40"><a href="#cb13-40" aria-hidden="true" tabindex="-1"></a>    <span class="at">states        =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&quot;surf_area&quot;</span>)),</span>
<span id="cb13-41"><a href="#cb13-41" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets =</span> <span class="cn">FALSE</span>,</span>
<span id="cb13-42"><a href="#cb13-42" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor     =</span> <span class="cn">TRUE</span>,</span>
<span id="cb13-43"><a href="#cb13-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_fun     =</span> <span class="fu">truncated_distributions</span>(<span class="st">&quot;norm&quot;</span>, <span class="st">&quot;c_d&quot;</span>)</span>
<span id="cb13-44"><a href="#cb13-44" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-45"><a href="#cb13-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb13-46"><a href="#cb13-46" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-47"><a href="#cb13-47" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Name can be anything, but it helps to make sure they&#39;re descriptive</span></span>
<span id="cb13-48"><a href="#cb13-48" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-49"><a href="#cb13-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">name =</span> <span class="st">&quot;go_discrete&quot;</span>,</span>
<span id="cb13-50"><a href="#cb13-50" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-51"><a href="#cb13-51" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Family is now &quot;CD&quot; because it is a continuous -&gt; discrete transition</span></span>
<span id="cb13-52"><a href="#cb13-52" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-53"><a href="#cb13-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&quot;CD&quot;</span>,</span>
<span id="cb13-54"><a href="#cb13-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> r_e <span class="sc">*</span> r_s <span class="sc">*</span> c_r <span class="sc">*</span> c_s <span class="sc">*</span> d_surf_area,</span>
<span id="cb13-55"><a href="#cb13-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">c_r_lin_p     =</span> c_r_int <span class="sc">+</span> c_r_slope <span class="sc">*</span> surf_area_1,</span>
<span id="cb13-56"><a href="#cb13-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">c_r           =</span> <span class="fu">inv_logit</span>(c_r_lin_p),</span>
<span id="cb13-57"><a href="#cb13-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">c_s           =</span> <span class="fu">exp</span>(c_s_int <span class="sc">+</span> c_s_slope <span class="sc">*</span> surf_area_1),</span>
<span id="cb13-58"><a href="#cb13-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list     =</span> constant_params,</span>
<span id="cb13-59"><a href="#cb13-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">states        =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&quot;surf_area&quot;</span>, <span class="st">&quot;sb&quot;</span>)),</span>
<span id="cb13-60"><a href="#cb13-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets =</span> <span class="cn">FALSE</span>,</span>
<span id="cb13-61"><a href="#cb13-61" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-62"><a href="#cb13-62" aria-hidden="true" tabindex="-1"></a>    <span class="co"># There is not eviction to correct here, so we can set this to false</span></span>
<span id="cb13-63"><a href="#cb13-63" aria-hidden="true" tabindex="-1"></a>    </span>
<span id="cb13-64"><a href="#cb13-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor     =</span> <span class="cn">FALSE</span></span>
<span id="cb13-65"><a href="#cb13-65" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-66"><a href="#cb13-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb13-67"><a href="#cb13-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">name          =</span> <span class="st">&quot;stay_discrete&quot;</span>,</span>
<span id="cb13-68"><a href="#cb13-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&quot;DD&quot;</span>,</span>
<span id="cb13-69"><a href="#cb13-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> r_s <span class="sc">*</span> r_r,</span>
<span id="cb13-70"><a href="#cb13-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list     =</span> constant_params,</span>
<span id="cb13-71"><a href="#cb13-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">states        =</span> <span class="fu">list</span>(<span class="st">&quot;sb&quot;</span>),</span>
<span id="cb13-72"><a href="#cb13-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets =</span> <span class="cn">FALSE</span>,</span>
<span id="cb13-73"><a href="#cb13-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor     =</span> <span class="cn">FALSE</span></span>
<span id="cb13-74"><a href="#cb13-74" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-75"><a href="#cb13-75" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb13-76"><a href="#cb13-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">name          =</span> <span class="st">&quot;leave_discrete&quot;</span>,</span>
<span id="cb13-77"><a href="#cb13-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&quot;DC&quot;</span>,</span>
<span id="cb13-78"><a href="#cb13-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> r_d <span class="sc">*</span> r_s <span class="sc">*</span> c_d <span class="sc">*</span> d_surf_area,</span>
<span id="cb13-79"><a href="#cb13-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">c_d           =</span> <span class="fu">dnorm</span>(surf_area_2, c_d_mu, c_d_sd),</span>
<span id="cb13-80"><a href="#cb13-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list     =</span> constant_params,</span>
<span id="cb13-81"><a href="#cb13-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">states        =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&quot;surf_area&quot;</span>, <span class="st">&quot;sb&quot;</span>)),</span>
<span id="cb13-82"><a href="#cb13-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets =</span> <span class="cn">FALSE</span>,</span>
<span id="cb13-83"><a href="#cb13-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor     =</span> <span class="cn">TRUE</span>,</span>
<span id="cb13-84"><a href="#cb13-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_fun     =</span> <span class="fu">truncated_distributions</span>(<span class="st">&quot;norm&quot;</span>, <span class="st">&quot;c_d&quot;</span>)</span>
<span id="cb13-85"><a href="#cb13-85" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-86"><a href="#cb13-86" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_impl</span>(</span>
<span id="cb13-87"><a href="#cb13-87" aria-hidden="true" tabindex="-1"></a>    <span class="fu">make_impl_args_list</span>(</span>
<span id="cb13-88"><a href="#cb13-88" aria-hidden="true" tabindex="-1"></a>      <span class="at">kernel_names =</span> <span class="fu">c</span>(<span class="st">&quot;P_stoch&quot;</span>, </span>
<span id="cb13-89"><a href="#cb13-89" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;F&quot;</span>,</span>
<span id="cb13-90"><a href="#cb13-90" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;go_discrete&quot;</span>, </span>
<span id="cb13-91"><a href="#cb13-91" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;stay_discrete&quot;</span>, </span>
<span id="cb13-92"><a href="#cb13-92" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;leave_discrete&quot;</span>),</span>
<span id="cb13-93"><a href="#cb13-93" aria-hidden="true" tabindex="-1"></a>      <span class="at">int_rule     =</span> <span class="fu">rep</span>(<span class="st">&quot;midpoint&quot;</span>, <span class="dv">5</span>),</span>
<span id="cb13-94"><a href="#cb13-94" aria-hidden="true" tabindex="-1"></a>      <span class="at">state_start  =</span> <span class="fu">c</span>(<span class="st">&quot;surf_area&quot;</span>, </span>
<span id="cb13-95"><a href="#cb13-95" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;surf_area&quot;</span>,</span>
<span id="cb13-96"><a href="#cb13-96" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;surf_area&quot;</span>,</span>
<span id="cb13-97"><a href="#cb13-97" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;sb&quot;</span>, </span>
<span id="cb13-98"><a href="#cb13-98" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;sb&quot;</span>),</span>
<span id="cb13-99"><a href="#cb13-99" aria-hidden="true" tabindex="-1"></a>      <span class="at">state_end    =</span> <span class="fu">c</span>(<span class="st">&quot;surf_area&quot;</span>,</span>
<span id="cb13-100"><a href="#cb13-100" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;surf_area&quot;</span>, </span>
<span id="cb13-101"><a href="#cb13-101" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;sb&quot;</span>, </span>
<span id="cb13-102"><a href="#cb13-102" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;sb&quot;</span>, </span>
<span id="cb13-103"><a href="#cb13-103" aria-hidden="true" tabindex="-1"></a>                       <span class="st">&quot;surf_area&quot;</span>)</span>
<span id="cb13-104"><a href="#cb13-104" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb13-105"><a href="#cb13-105" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb13-106"><a href="#cb13-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_domains</span>(</span>
<span id="cb13-107"><a href="#cb13-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">surf_area =</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">10</span>, <span class="dv">100</span>)</span>
<span id="cb13-108"><a href="#cb13-108" aria-hidden="true" tabindex="-1"></a>  ) </span></code></pre></div>
<p>Now, we need to <code>define_env_state()</code>. This consists of two parts - specifying expressions that generate environmental covariates, and supplying the information needed to evaluate those expressions. In this example, we want to use the <code>env_params</code> in <code>sample_env</code> (i.e. <code>sample_env(env_params)</code>). <code>define_env_state</code> uses the <code>data_list</code> argument to supply the <code>env_params</code>, and the call to <code>sample_env</code> goes into the <code>...</code> portion of the function. Here, we assign the result to <code>env_covs</code>. The name <code>env_covs</code> isn’t important for specifying vital rate expressions and you could call it whatever you want, but it must be named something in order to work properly. The only thing that needs to match are the names in the list that <code>sample_env</code> returns, and the names used in the vital rate expressions/kernels.</p>
<p>Note that you can pass the <code>sample_env</code> function in either the <code>data_list</code> of <code>define_env_state()</code>, or the <code>usr_funs</code> argument of <code>make_ipm()</code>.</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="co"># In the first version, sample_env is provided in the data_list of </span></span>
<span id="cb14-2"><a href="#cb14-2" aria-hidden="true" tabindex="-1"></a><span class="co"># define_env_state.</span></span>
<span id="cb14-3"><a href="#cb14-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-4"><a href="#cb14-4" aria-hidden="true" tabindex="-1"></a>general_stoch_param_ipm <span class="ot">&lt;-</span>  <span class="fu">define_env_state</span>(</span>
<span id="cb14-5"><a href="#cb14-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">proto_ipm  =</span> general_stoch_param_model,</span>
<span id="cb14-6"><a href="#cb14-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">env_covs   =</span> <span class="fu">sample_env</span>(env_params),</span>
<span id="cb14-7"><a href="#cb14-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_list  =</span> <span class="fu">list</span>(<span class="at">env_params =</span> env_params,</span>
<span id="cb14-8"><a href="#cb14-8" aria-hidden="true" tabindex="-1"></a>                    <span class="at">sample_env =</span> sample_env)</span>
<span id="cb14-9"><a href="#cb14-9" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-10"><a href="#cb14-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_pop_state</span>(</span>
<span id="cb14-11"><a href="#cb14-11" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_surf_area =</span> <span class="fu">runif</span>(<span class="dv">100</span>),</span>
<span id="cb14-12"><a href="#cb14-12" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_sb        =</span> <span class="fu">rpois</span>(<span class="dv">1</span>, <span class="dv">20</span>)</span>
<span id="cb14-13"><a href="#cb14-13" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-14"><a href="#cb14-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">make_ipm</span>(<span class="at">usr_funs =</span> <span class="fu">list</span>(<span class="at">inv_logit  =</span> inv_logit),</span>
<span id="cb14-15"><a href="#cb14-15" aria-hidden="true" tabindex="-1"></a>           <span class="at">iterate =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-16"><a href="#cb14-16" aria-hidden="true" tabindex="-1"></a>           <span class="at">iterations =</span> <span class="dv">100</span>)</span>
<span id="cb14-17"><a href="#cb14-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-18"><a href="#cb14-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-19"><a href="#cb14-19" aria-hidden="true" tabindex="-1"></a><span class="co"># in the second version, sample_env is provided in the usr_funs list of </span></span>
<span id="cb14-20"><a href="#cb14-20" aria-hidden="true" tabindex="-1"></a><span class="co"># make_ipm(). These two versions are equivalent. </span></span>
<span id="cb14-21"><a href="#cb14-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb14-22"><a href="#cb14-22" aria-hidden="true" tabindex="-1"></a>general_stoch_param_ipm <span class="ot">&lt;-</span>  <span class="fu">define_env_state</span>(</span>
<span id="cb14-23"><a href="#cb14-23" aria-hidden="true" tabindex="-1"></a>  <span class="at">proto_ipm  =</span> general_stoch_param_model,</span>
<span id="cb14-24"><a href="#cb14-24" aria-hidden="true" tabindex="-1"></a>  <span class="at">env_covs   =</span> <span class="fu">sample_env</span>(env_params),</span>
<span id="cb14-25"><a href="#cb14-25" aria-hidden="true" tabindex="-1"></a>  <span class="at">data_list  =</span> <span class="fu">list</span>(<span class="at">env_params =</span> env_params)</span>
<span id="cb14-26"><a href="#cb14-26" aria-hidden="true" tabindex="-1"></a>) <span class="sc">%&gt;%</span> </span>
<span id="cb14-27"><a href="#cb14-27" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_pop_state</span>(</span>
<span id="cb14-28"><a href="#cb14-28" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_surf_area =</span> <span class="fu">runif</span>(<span class="dv">100</span>),</span>
<span id="cb14-29"><a href="#cb14-29" aria-hidden="true" tabindex="-1"></a>    <span class="at">n_sb        =</span> <span class="fu">rpois</span>(<span class="dv">1</span>, <span class="dv">20</span>)</span>
<span id="cb14-30"><a href="#cb14-30" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb14-31"><a href="#cb14-31" aria-hidden="true" tabindex="-1"></a>  <span class="fu">make_ipm</span>(<span class="at">usr_funs =</span> <span class="fu">list</span>(<span class="at">inv_logit  =</span> inv_logit,</span>
<span id="cb14-32"><a href="#cb14-32" aria-hidden="true" tabindex="-1"></a>                           <span class="at">sample_env =</span> sample_env),</span>
<span id="cb14-33"><a href="#cb14-33" aria-hidden="true" tabindex="-1"></a>           <span class="at">iterate =</span> <span class="cn">TRUE</span>,</span>
<span id="cb14-34"><a href="#cb14-34" aria-hidden="true" tabindex="-1"></a>           <span class="at">iterations =</span> <span class="dv">100</span>)</span></code></pre></div>
<p>Stochastic parameter-resampled models also return an <code>env_seq</code>, but this time it will be a <code>data.frame</code> of parameter draws rather than a character vector. We can also compute mean sub-kernels and <span class="math inline">\(\lambda_s\)</span> as we did in the kernel-resampled models. This time, each mean kernel is computed as the average of each sub-kernel over the course of the simulation (i.e. mean of all <code>P</code> kernels). Some sub-kernels in our example are not time-varying - they will be numerically equivalent to the sub-kernels stored in the IPM object.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" aria-hidden="true" tabindex="-1"></a>env_draws  <span class="ot">&lt;-</span> general_stoch_param_ipm<span class="sc">$</span>env_seq</span>
<span id="cb15-2"><a href="#cb15-2" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" aria-hidden="true" tabindex="-1"></a>mean_kerns <span class="ot">&lt;-</span> <span class="fu">mean_kernel</span>(general_stoch_param_ipm)</span>
<span id="cb15-4"><a href="#cb15-4" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" aria-hidden="true" tabindex="-1"></a>lam_s      <span class="ot">&lt;-</span> <span class="fu">lambda</span>(general_stoch_param_ipm)</span>
<span id="cb15-6"><a href="#cb15-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb15-7"><a href="#cb15-7" aria-hidden="true" tabindex="-1"></a><span class="fu">all.equal</span>(mean_kerns<span class="sc">$</span>mean_F, </span>
<span id="cb15-8"><a href="#cb15-8" aria-hidden="true" tabindex="-1"></a>          general_stoch_param_ipm<span class="sc">$</span>sub_kernels<span class="sc">$</span>F_it_1,</span>
<span id="cb15-9"><a href="#cb15-9" aria-hidden="true" tabindex="-1"></a>          <span class="at">check.attributes =</span> <span class="cn">FALSE</span>)</span></code></pre></div>
</div>
</div>
<div id="code-to-construct-mega-kernels" class="section level2">
<h2>Code to construct mega-kernels</h2>
<p>Sometimes, we may want to work with our sub-kernels arranged into a single block kernel. This isn’t required for any of the code in <code>ipmr</code>, except for the <code>plot</code> method for <code>general_di_det</code> IPMs. Other use cases may arise for analyses not included in this package though, so below is a brief overview of how to generate those.</p>
<p><code>make_iter_kernel()</code> takes an IPM object and a vector of symbols (for interactive use) or a character version of the expression (for programming) showing where each sub-kernel should go. It works in <strong>ROW MAJOR order</strong>. This example will use the model from the general deterministic example at the top of the article.</p>
<p>First, re-run the model to create the IPM object (if you haven’t already).</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>data_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_int     =</span> <span class="fl">5.781</span>,</span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_slope   =</span> <span class="fl">0.988</span>,</span>
<span id="cb16-4"><a href="#cb16-4" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_sd      =</span> <span class="fl">20.55699</span>,</span>
<span id="cb16-5"><a href="#cb16-5" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_int     =</span> <span class="sc">-</span><span class="fl">0.352</span>,</span>
<span id="cb16-6"><a href="#cb16-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_slope   =</span> <span class="fl">0.122</span>,</span>
<span id="cb16-7"><a href="#cb16-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_slope_2 =</span> <span class="sc">-</span><span class="fl">0.000213</span>,</span>
<span id="cb16-8"><a href="#cb16-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_r_int   =</span> <span class="sc">-</span><span class="fl">11.46</span>,</span>
<span id="cb16-9"><a href="#cb16-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_r_slope =</span> <span class="fl">0.0835</span>,</span>
<span id="cb16-10"><a href="#cb16-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_s_int   =</span> <span class="fl">2.6204</span>,</span>
<span id="cb16-11"><a href="#cb16-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_s_slope =</span> <span class="fl">0.01256</span>,</span>
<span id="cb16-12"><a href="#cb16-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_d_mu    =</span> <span class="fl">5.6655</span>,</span>
<span id="cb16-13"><a href="#cb16-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">r_d_sd    =</span> <span class="fl">2.0734</span>,</span>
<span id="cb16-14"><a href="#cb16-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">e_p       =</span> <span class="fl">0.15</span>,</span>
<span id="cb16-15"><a href="#cb16-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_i       =</span> <span class="fl">0.5067</span></span>
<span id="cb16-16"><a href="#cb16-16" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb16-17"><a href="#cb16-17" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-18"><a href="#cb16-18" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-19"><a href="#cb16-19" aria-hidden="true" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="fl">1.02</span></span>
<span id="cb16-20"><a href="#cb16-20" aria-hidden="true" tabindex="-1"></a>U <span class="ot">&lt;-</span> <span class="dv">624</span></span>
<span id="cb16-21"><a href="#cb16-21" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb16-22"><a href="#cb16-22" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-23"><a href="#cb16-23" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2312</span>)</span>
<span id="cb16-24"><a href="#cb16-24" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-25"><a href="#cb16-25" aria-hidden="true" tabindex="-1"></a>init_pop_vec   <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">500</span>)</span>
<span id="cb16-26"><a href="#cb16-26" aria-hidden="true" tabindex="-1"></a>init_seed_bank <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb16-27"><a href="#cb16-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-28"><a href="#cb16-28" aria-hidden="true" tabindex="-1"></a><span class="co"># Initialize the state list and add some helper functions. The survival function</span></span>
<span id="cb16-29"><a href="#cb16-29" aria-hidden="true" tabindex="-1"></a><span class="co"># in this model is a quadratic function.</span></span>
<span id="cb16-30"><a href="#cb16-30" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-31"><a href="#cb16-31" aria-hidden="true" tabindex="-1"></a>inv_logit <span class="ot">&lt;-</span> <span class="cf">function</span>(int, slope, sv) {</span>
<span id="cb16-32"><a href="#cb16-32" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>(int <span class="sc">+</span> slope <span class="sc">*</span> sv)))</span>
<span id="cb16-33"><a href="#cb16-33" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-34"><a href="#cb16-34" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-35"><a href="#cb16-35" aria-hidden="true" tabindex="-1"></a>inv_logit_2 <span class="ot">&lt;-</span> <span class="cf">function</span>(int, slope, slope_2, sv) {</span>
<span id="cb16-36"><a href="#cb16-36" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>(int <span class="sc">+</span> slope <span class="sc">*</span> sv <span class="sc">+</span> slope_2 <span class="sc">*</span> sv <span class="sc">^</span> <span class="dv">2</span>)))</span>
<span id="cb16-37"><a href="#cb16-37" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb16-38"><a href="#cb16-38" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb16-39"><a href="#cb16-39" aria-hidden="true" tabindex="-1"></a>general_ipm <span class="ot">&lt;-</span> <span class="fu">init_ipm</span>(<span class="at">sim_gen    =</span> <span class="st">&quot;general&quot;</span>,</span>
<span id="cb16-40"><a href="#cb16-40" aria-hidden="true" tabindex="-1"></a>                        <span class="at">di_dd      =</span> <span class="st">&quot;di&quot;</span>, </span>
<span id="cb16-41"><a href="#cb16-41" aria-hidden="true" tabindex="-1"></a>                        <span class="at">det_stoch  =</span> <span class="st">&quot;det&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb16-42"><a href="#cb16-42" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb16-43"><a href="#cb16-43" aria-hidden="true" tabindex="-1"></a>    <span class="at">name          =</span> <span class="st">&quot;P&quot;</span>,</span>
<span id="cb16-44"><a href="#cb16-44" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> s <span class="sc">*</span> g <span class="sc">*</span> d_ht,</span>
<span id="cb16-45"><a href="#cb16-45" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&quot;CC&quot;</span>,</span>
<span id="cb16-46"><a href="#cb16-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">g             =</span> <span class="fu">dnorm</span>(ht_2, g_mu, g_sd),</span>
<span id="cb16-47"><a href="#cb16-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">g_mu          =</span> g_int <span class="sc">+</span> g_slope <span class="sc">*</span> ht_1,</span>
<span id="cb16-48"><a href="#cb16-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">s             =</span> <span class="fu">inv_logit_2</span>(s_int, s_slope, s_slope_2, ht_1),</span>
<span id="cb16-49"><a href="#cb16-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list     =</span> data_list,</span>
<span id="cb16-50"><a href="#cb16-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">states        =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>)),</span>
<span id="cb16-51"><a href="#cb16-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-52"><a href="#cb16-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor     =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-53"><a href="#cb16-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_fun     =</span> <span class="fu">truncated_distributions</span>(<span class="st">&#39;norm&#39;</span>,</span>
<span id="cb16-54"><a href="#cb16-54" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">&#39;g&#39;</span>)</span>
<span id="cb16-55"><a href="#cb16-55" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb16-56"><a href="#cb16-56" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb16-57"><a href="#cb16-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">name          =</span> <span class="st">&quot;go_discrete&quot;</span>,</span>
<span id="cb16-58"><a href="#cb16-58" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> r_r <span class="sc">*</span> r_s <span class="sc">*</span> g_i,</span>
<span id="cb16-59"><a href="#cb16-59" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&#39;CD&#39;</span>,</span>
<span id="cb16-60"><a href="#cb16-60" aria-hidden="true" tabindex="-1"></a>    <span class="at">r_r           =</span> <span class="fu">inv_logit</span>(r_r_int, r_r_slope, ht_1),</span>
<span id="cb16-61"><a href="#cb16-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">r_s           =</span> <span class="fu">exp</span>(r_s_int <span class="sc">+</span> r_s_slope <span class="sc">*</span> ht_1),</span>
<span id="cb16-62"><a href="#cb16-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list     =</span> data_list,</span>
<span id="cb16-63"><a href="#cb16-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">states        =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>, <span class="st">&quot;b&quot;</span>)),</span>
<span id="cb16-64"><a href="#cb16-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets =</span> <span class="cn">FALSE</span></span>
<span id="cb16-65"><a href="#cb16-65" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb16-66"><a href="#cb16-66" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb16-67"><a href="#cb16-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">name      =</span> <span class="st">&#39;stay_discrete&#39;</span>,</span>
<span id="cb16-68"><a href="#cb16-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula   =</span> <span class="dv">0</span>,</span>
<span id="cb16-69"><a href="#cb16-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">family    =</span> <span class="st">&quot;DD&quot;</span>,  </span>
<span id="cb16-70"><a href="#cb16-70" aria-hidden="true" tabindex="-1"></a>    <span class="at">states    =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>, <span class="st">&quot;b&quot;</span>)),</span>
<span id="cb16-71"><a href="#cb16-71" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor =</span> <span class="cn">FALSE</span></span>
<span id="cb16-72"><a href="#cb16-72" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb16-73"><a href="#cb16-73" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb16-74"><a href="#cb16-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">name          =</span> <span class="st">&#39;leave_discrete&#39;</span>,</span>
<span id="cb16-75"><a href="#cb16-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> e_p <span class="sc">*</span> r_d <span class="sc">*</span> d_ht,</span>
<span id="cb16-76"><a href="#cb16-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">r_d           =</span> <span class="fu">dnorm</span>(ht_2, r_d_mu, r_d_sd),</span>
<span id="cb16-77"><a href="#cb16-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&#39;DC&#39;</span>,</span>
<span id="cb16-78"><a href="#cb16-78" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list     =</span> data_list,</span>
<span id="cb16-79"><a href="#cb16-79" aria-hidden="true" tabindex="-1"></a>    <span class="at">states        =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>, <span class="st">&quot;b&quot;</span>)),</span>
<span id="cb16-80"><a href="#cb16-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets =</span> <span class="cn">FALSE</span>,</span>
<span id="cb16-81"><a href="#cb16-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor     =</span> <span class="cn">TRUE</span>,</span>
<span id="cb16-82"><a href="#cb16-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_fun     =</span> <span class="fu">truncated_distributions</span>(<span class="st">&#39;norm&#39;</span>,</span>
<span id="cb16-83"><a href="#cb16-83" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">&#39;r_d&#39;</span>)</span>
<span id="cb16-84"><a href="#cb16-84" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb16-85"><a href="#cb16-85" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_impl</span>(</span>
<span id="cb16-86"><a href="#cb16-86" aria-hidden="true" tabindex="-1"></a>    <span class="fu">make_impl_args_list</span>(</span>
<span id="cb16-87"><a href="#cb16-87" aria-hidden="true" tabindex="-1"></a>      <span class="at">kernel_names =</span> <span class="fu">c</span>(<span class="st">&quot;P&quot;</span>, <span class="st">&quot;go_discrete&quot;</span>, <span class="st">&quot;stay_discrete&quot;</span>, <span class="st">&quot;leave_discrete&quot;</span>),</span>
<span id="cb16-88"><a href="#cb16-88" aria-hidden="true" tabindex="-1"></a>      <span class="at">int_rule     =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&quot;midpoint&quot;</span>, <span class="dv">4</span>)),</span>
<span id="cb16-89"><a href="#cb16-89" aria-hidden="true" tabindex="-1"></a>      <span class="at">state_start    =</span> <span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>, <span class="st">&quot;ht&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;b&quot;</span>),</span>
<span id="cb16-90"><a href="#cb16-90" aria-hidden="true" tabindex="-1"></a>      <span class="at">state_end      =</span> <span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&#39;ht&#39;</span>)</span>
<span id="cb16-91"><a href="#cb16-91" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-92"><a href="#cb16-92" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb16-93"><a href="#cb16-93" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_domains</span>(</span>
<span id="cb16-94"><a href="#cb16-94" aria-hidden="true" tabindex="-1"></a>    <span class="at">ht =</span> <span class="fu">c</span>(L, U, n)</span>
<span id="cb16-95"><a href="#cb16-95" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb16-96"><a href="#cb16-96" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_pop_state</span>(</span>
<span id="cb16-97"><a href="#cb16-97" aria-hidden="true" tabindex="-1"></a>    <span class="at">pop_vectors =</span> <span class="fu">list</span>(</span>
<span id="cb16-98"><a href="#cb16-98" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_ht =</span> init_pop_vec,</span>
<span id="cb16-99"><a href="#cb16-99" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_b  =</span> init_seed_bank</span>
<span id="cb16-100"><a href="#cb16-100" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb16-101"><a href="#cb16-101" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb16-102"><a href="#cb16-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">make_ipm</span>(<span class="at">iterations =</span> <span class="dv">100</span>,</span>
<span id="cb16-103"><a href="#cb16-103" aria-hidden="true" tabindex="-1"></a>           <span class="at">usr_funs =</span> <span class="fu">list</span>(<span class="at">inv_logit   =</span> inv_logit,</span>
<span id="cb16-104"><a href="#cb16-104" aria-hidden="true" tabindex="-1"></a>                           <span class="at">inv_logit_2 =</span> inv_logit_2))</span></code></pre></div>
<p>Now, we specify which kernel belongs where in row major order, using a call to <code>c()</code>.</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" aria-hidden="true" tabindex="-1"></a>mega_mat <span class="ot">&lt;-</span> <span class="fu">make_iter_kernel</span>(<span class="at">ipm =</span> general_ipm,</span>
<span id="cb17-2"><a href="#cb17-2" aria-hidden="true" tabindex="-1"></a>                             <span class="at">mega_mat =</span> <span class="fu">c</span>(</span>
<span id="cb17-3"><a href="#cb17-3" aria-hidden="true" tabindex="-1"></a>                               stay_discrete, go_discrete,</span>
<span id="cb17-4"><a href="#cb17-4" aria-hidden="true" tabindex="-1"></a>                               leave_discrete, P</span>
<span id="cb17-5"><a href="#cb17-5" aria-hidden="true" tabindex="-1"></a>                             ))</span>
<span id="cb17-6"><a href="#cb17-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-7"><a href="#cb17-7" aria-hidden="true" tabindex="-1"></a><span class="co"># These values should be almost identical, so this should ~0</span></span>
<span id="cb17-8"><a href="#cb17-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" aria-hidden="true" tabindex="-1"></a><span class="fu">Re</span>(<span class="fu">eigen</span>(mega_mat[[<span class="dv">1</span>]])<span class="sc">$</span>values[<span class="dv">1</span>]) <span class="sc">-</span> <span class="fu">lambda</span>(general_ipm)</span></code></pre></div>
<p>Say we wanted to program with this function. Passing bare expression is difficult programatically, and how to do that is not really within the scope of this vignette (though if you’re interested in learning how, <a href="https://dplyr.tidyverse.org/articles/programming.html">this</a> is a good start). <code>make_iter_kernel()</code> also accepts text strings in the same format as above.</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Get the names of each sub_kernel</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>sub_k_nms     <span class="ot">&lt;-</span> <span class="fu">names</span>(general_ipm<span class="sc">$</span>sub_kernels)</span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-4"><a href="#cb18-4" aria-hidden="true" tabindex="-1"></a>mega_mat_text <span class="ot">&lt;-</span> <span class="fu">c</span>(sub_k_nms[<span class="dv">3</span>], sub_k_nms[<span class="dv">2</span>], sub_k_nms[<span class="dv">4</span>], sub_k_nms[<span class="dv">1</span>])</span>
<span id="cb18-5"><a href="#cb18-5" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-6"><a href="#cb18-6" aria-hidden="true" tabindex="-1"></a>mega_mat_2 <span class="ot">&lt;-</span> <span class="fu">make_iter_kernel</span>(general_ipm,</span>
<span id="cb18-7"><a href="#cb18-7" aria-hidden="true" tabindex="-1"></a>                               <span class="at">mega_mat =</span> mega_mat_text)</span>
<span id="cb18-8"><a href="#cb18-8" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb18-9"><a href="#cb18-9" aria-hidden="true" tabindex="-1"></a><span class="co"># Should be TRUE</span></span>
<span id="cb18-10"><a href="#cb18-10" aria-hidden="true" tabindex="-1"></a><span class="fu">identical</span>(mega_mat, mega_mat_2)</span></code></pre></div>
<p><code>make_iter_kernel()</code> can also handle cases where you need blocks of 0s or identity matrices. These are specified using <code>0</code> for 0s, and <code>I</code> for identity matrices. <code>make_iter_kernel()</code> automatically works out the correct dimensions internally, so you don’t need to worry about specifying those.</p>
<p>Below is an example that inserts 0s and identity matrices on the off-diagonals with the <code>P</code> kernel duplicated along the diagonal.</p>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" aria-hidden="true" tabindex="-1"></a>mega_mat <span class="ot">&lt;-</span> <span class="fu">make_iter_kernel</span>(general_ipm,</span>
<span id="cb19-2"><a href="#cb19-2" aria-hidden="true" tabindex="-1"></a>                               <span class="at">mega_mat =</span> <span class="fu">c</span>(P, <span class="dv">0</span>, </span>
<span id="cb19-3"><a href="#cb19-3" aria-hidden="true" tabindex="-1"></a>                                            I, P))</span></code></pre></div>
<p>Finally, <code>make_iter_kernel</code> supports <code>ipmr</code>’s parameter set index syntax as well, enabling us to generate a list of mega-kernels for each combination of parameter set values. We’ll re-run the <code>&quot;general_di_stoch_kern&quot;</code> example from above to demonstrate this.</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>all_g_int   <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="fu">rnorm</span>(<span class="dv">5</span>, <span class="at">mean =</span> <span class="fl">5.781</span>, <span class="at">sd =</span> <span class="fl">0.9</span>)) </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>all_f_s_int <span class="ot">&lt;-</span> <span class="fu">as.list</span>(<span class="fu">rnorm</span>(<span class="dv">5</span>, <span class="at">mean =</span> <span class="fl">2.6204</span>, <span class="at">sd =</span> <span class="fl">0.3</span>))</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(all_g_int)   <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;g_int_&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a><span class="fu">names</span>(all_f_s_int) <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;f_s_int_&quot;</span>, <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">sep =</span> <span class="st">&quot;&quot;</span>)</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>constant_list <span class="ot">&lt;-</span> <span class="fu">list</span>(</span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_slope   =</span> <span class="fl">0.988</span>,</span>
<span id="cb20-9"><a href="#cb20-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_sd      =</span> <span class="fl">20.55699</span>,</span>
<span id="cb20-10"><a href="#cb20-10" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_int     =</span> <span class="sc">-</span><span class="fl">0.352</span>,</span>
<span id="cb20-11"><a href="#cb20-11" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_slope   =</span> <span class="fl">0.122</span>,</span>
<span id="cb20-12"><a href="#cb20-12" aria-hidden="true" tabindex="-1"></a>  <span class="at">s_slope_2 =</span> <span class="sc">-</span><span class="fl">0.000213</span>,</span>
<span id="cb20-13"><a href="#cb20-13" aria-hidden="true" tabindex="-1"></a>  <span class="at">f_r_int   =</span> <span class="sc">-</span><span class="fl">11.46</span>,</span>
<span id="cb20-14"><a href="#cb20-14" aria-hidden="true" tabindex="-1"></a>  <span class="at">f_r_slope =</span> <span class="fl">0.0835</span>,</span>
<span id="cb20-15"><a href="#cb20-15" aria-hidden="true" tabindex="-1"></a>  <span class="at">f_s_slope =</span> <span class="fl">0.01256</span>,</span>
<span id="cb20-16"><a href="#cb20-16" aria-hidden="true" tabindex="-1"></a>  <span class="at">f_d_mu    =</span> <span class="fl">5.6655</span>,</span>
<span id="cb20-17"><a href="#cb20-17" aria-hidden="true" tabindex="-1"></a>  <span class="at">f_d_sd    =</span> <span class="fl">2.0734</span>,</span>
<span id="cb20-18"><a href="#cb20-18" aria-hidden="true" tabindex="-1"></a>  <span class="at">e_p       =</span> <span class="fl">0.15</span>,</span>
<span id="cb20-19"><a href="#cb20-19" aria-hidden="true" tabindex="-1"></a>  <span class="at">g_i       =</span> <span class="fl">0.5067</span></span>
<span id="cb20-20"><a href="#cb20-20" aria-hidden="true" tabindex="-1"></a>)</span>
<span id="cb20-21"><a href="#cb20-21" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-22"><a href="#cb20-22" aria-hidden="true" tabindex="-1"></a>all_params <span class="ot">&lt;-</span> <span class="fu">c</span>(constant_list, all_g_int, all_f_s_int)</span>
<span id="cb20-23"><a href="#cb20-23" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-24"><a href="#cb20-24" aria-hidden="true" tabindex="-1"></a>L <span class="ot">&lt;-</span> <span class="fl">1.02</span></span>
<span id="cb20-25"><a href="#cb20-25" aria-hidden="true" tabindex="-1"></a>U <span class="ot">&lt;-</span> <span class="dv">624</span></span>
<span id="cb20-26"><a href="#cb20-26" aria-hidden="true" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">500</span></span>
<span id="cb20-27"><a href="#cb20-27" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-28"><a href="#cb20-28" aria-hidden="true" tabindex="-1"></a><span class="fu">set.seed</span>(<span class="dv">2312</span>)</span>
<span id="cb20-29"><a href="#cb20-29" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-30"><a href="#cb20-30" aria-hidden="true" tabindex="-1"></a>init_pop_vec   <span class="ot">&lt;-</span> <span class="fu">runif</span>(<span class="dv">500</span>)</span>
<span id="cb20-31"><a href="#cb20-31" aria-hidden="true" tabindex="-1"></a>init_seed_bank <span class="ot">&lt;-</span> <span class="dv">20</span></span>
<span id="cb20-32"><a href="#cb20-32" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-33"><a href="#cb20-33" aria-hidden="true" tabindex="-1"></a>inv_logit <span class="ot">&lt;-</span> <span class="cf">function</span>(int, slope, sv) {</span>
<span id="cb20-34"><a href="#cb20-34" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>(int <span class="sc">+</span> slope <span class="sc">*</span> sv)))</span>
<span id="cb20-35"><a href="#cb20-35" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-36"><a href="#cb20-36" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-37"><a href="#cb20-37" aria-hidden="true" tabindex="-1"></a>inv_logit_2 <span class="ot">&lt;-</span> <span class="cf">function</span>(int, slope, slope_2, sv) {</span>
<span id="cb20-38"><a href="#cb20-38" aria-hidden="true" tabindex="-1"></a>  <span class="dv">1</span><span class="sc">/</span>(<span class="dv">1</span> <span class="sc">+</span> <span class="fu">exp</span>(<span class="sc">-</span>(int <span class="sc">+</span> slope <span class="sc">*</span> sv <span class="sc">+</span> slope_2 <span class="sc">*</span> sv <span class="sc">^</span> <span class="dv">2</span>)))</span>
<span id="cb20-39"><a href="#cb20-39" aria-hidden="true" tabindex="-1"></a>}</span>
<span id="cb20-40"><a href="#cb20-40" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-41"><a href="#cb20-41" aria-hidden="true" tabindex="-1"></a>general_stoch_kern_ipm <span class="ot">&lt;-</span> <span class="fu">init_ipm</span>(<span class="at">sim_gen    =</span> <span class="st">&quot;general&quot;</span>,</span>
<span id="cb20-42"><a href="#cb20-42" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">di_dd      =</span> <span class="st">&quot;di&quot;</span>, </span>
<span id="cb20-43"><a href="#cb20-43" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">det_stoch  =</span> <span class="st">&quot;stoch&quot;</span>,</span>
<span id="cb20-44"><a href="#cb20-44" aria-hidden="true" tabindex="-1"></a>                                   <span class="at">kern_param =</span> <span class="st">&quot;kern&quot;</span>) <span class="sc">%&gt;%</span></span>
<span id="cb20-45"><a href="#cb20-45" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb20-46"><a href="#cb20-46" aria-hidden="true" tabindex="-1"></a>    <span class="at">name          =</span> <span class="st">&quot;P_year&quot;</span>,</span>
<span id="cb20-47"><a href="#cb20-47" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> s <span class="sc">*</span> g_year <span class="sc">*</span> d_ht,</span>
<span id="cb20-48"><a href="#cb20-48" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&quot;CC&quot;</span>,</span>
<span id="cb20-49"><a href="#cb20-49" aria-hidden="true" tabindex="-1"></a>    <span class="at">g_year           =</span> <span class="fu">dnorm</span>(ht_2, g_mu_year, g_sd),</span>
<span id="cb20-50"><a href="#cb20-50" aria-hidden="true" tabindex="-1"></a>    <span class="at">g_mu_year        =</span> g_int_year <span class="sc">+</span> g_slope <span class="sc">*</span> ht_1,</span>
<span id="cb20-51"><a href="#cb20-51" aria-hidden="true" tabindex="-1"></a>    <span class="at">s                =</span> <span class="fu">inv_logit_2</span>(s_int, s_slope, s_slope_2, ht_1),</span>
<span id="cb20-52"><a href="#cb20-52" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list        =</span> all_params,</span>
<span id="cb20-53"><a href="#cb20-53" aria-hidden="true" tabindex="-1"></a>    <span class="at">states           =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>)),</span>
<span id="cb20-54"><a href="#cb20-54" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets    =</span> <span class="cn">TRUE</span>,</span>
<span id="cb20-55"><a href="#cb20-55" aria-hidden="true" tabindex="-1"></a>    <span class="at">par_set_indices =</span> <span class="fu">list</span>(<span class="at">year =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>),</span>
<span id="cb20-56"><a href="#cb20-56" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor        =</span> <span class="cn">TRUE</span>,</span>
<span id="cb20-57"><a href="#cb20-57" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_fun        =</span> <span class="fu">truncated_distributions</span>(<span class="st">&#39;norm&#39;</span>,</span>
<span id="cb20-58"><a href="#cb20-58" aria-hidden="true" tabindex="-1"></a>                                               <span class="st">&#39;g_year&#39;</span>)</span>
<span id="cb20-59"><a href="#cb20-59" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-60"><a href="#cb20-60" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb20-61"><a href="#cb20-61" aria-hidden="true" tabindex="-1"></a>    <span class="at">name          =</span> <span class="st">&quot;go_discrete_year&quot;</span>,</span>
<span id="cb20-62"><a href="#cb20-62" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> f_r <span class="sc">*</span> f_s_year <span class="sc">*</span> g_i <span class="sc">*</span> d_ht,</span>
<span id="cb20-63"><a href="#cb20-63" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&#39;CD&#39;</span>,</span>
<span id="cb20-64"><a href="#cb20-64" aria-hidden="true" tabindex="-1"></a>    <span class="at">f_r           =</span> <span class="fu">inv_logit</span>(f_r_int, f_r_slope, ht_1),</span>
<span id="cb20-65"><a href="#cb20-65" aria-hidden="true" tabindex="-1"></a>    <span class="at">f_s_year      =</span> <span class="fu">exp</span>(f_s_int_year <span class="sc">+</span> f_s_slope <span class="sc">*</span> ht_1),</span>
<span id="cb20-66"><a href="#cb20-66" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list     =</span> all_params,</span>
<span id="cb20-67"><a href="#cb20-67" aria-hidden="true" tabindex="-1"></a>    <span class="at">states        =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>, <span class="st">&quot;b&quot;</span>)),</span>
<span id="cb20-68"><a href="#cb20-68" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets    =</span> <span class="cn">TRUE</span>,</span>
<span id="cb20-69"><a href="#cb20-69" aria-hidden="true" tabindex="-1"></a>    <span class="at">par_set_indices =</span> <span class="fu">list</span>(<span class="at">year =</span> <span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>)</span>
<span id="cb20-70"><a href="#cb20-70" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-71"><a href="#cb20-71" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb20-72"><a href="#cb20-72" aria-hidden="true" tabindex="-1"></a>    <span class="at">name    =</span> <span class="st">&#39;stay_discrete&#39;</span>,</span>
<span id="cb20-73"><a href="#cb20-73" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula =</span> <span class="dv">0</span>,</span>
<span id="cb20-74"><a href="#cb20-74" aria-hidden="true" tabindex="-1"></a>    <span class="at">family  =</span> <span class="st">&quot;DD&quot;</span>,</span>
<span id="cb20-75"><a href="#cb20-75" aria-hidden="true" tabindex="-1"></a>    <span class="at">states  =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;b&#39;</span>)),</span>
<span id="cb20-76"><a href="#cb20-76" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets =</span> <span class="cn">FALSE</span>,</span>
<span id="cb20-77"><a href="#cb20-77" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor =</span> <span class="cn">FALSE</span></span>
<span id="cb20-78"><a href="#cb20-78" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-79"><a href="#cb20-79" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_kernel</span>(</span>
<span id="cb20-80"><a href="#cb20-80" aria-hidden="true" tabindex="-1"></a>    <span class="at">name          =</span> <span class="st">&#39;leave_discrete&#39;</span>,</span>
<span id="cb20-81"><a href="#cb20-81" aria-hidden="true" tabindex="-1"></a>    <span class="at">formula       =</span> e_p <span class="sc">*</span> f_d <span class="sc">*</span> d_ht,</span>
<span id="cb20-82"><a href="#cb20-82" aria-hidden="true" tabindex="-1"></a>    <span class="at">f_d           =</span> <span class="fu">dnorm</span>(ht_2, f_d_mu, f_d_sd),</span>
<span id="cb20-83"><a href="#cb20-83" aria-hidden="true" tabindex="-1"></a>    <span class="at">family        =</span> <span class="st">&#39;DC&#39;</span>,</span>
<span id="cb20-84"><a href="#cb20-84" aria-hidden="true" tabindex="-1"></a>    <span class="at">data_list     =</span> all_params,</span>
<span id="cb20-85"><a href="#cb20-85" aria-hidden="true" tabindex="-1"></a>    <span class="at">states        =</span> <span class="fu">list</span>(<span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>, <span class="st">&quot;b&quot;</span>)),</span>
<span id="cb20-86"><a href="#cb20-86" aria-hidden="true" tabindex="-1"></a>    <span class="at">uses_par_sets =</span> <span class="cn">FALSE</span>,</span>
<span id="cb20-87"><a href="#cb20-87" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_cor     =</span> <span class="cn">TRUE</span>,</span>
<span id="cb20-88"><a href="#cb20-88" aria-hidden="true" tabindex="-1"></a>    <span class="at">evict_fun     =</span> <span class="fu">truncated_distributions</span>(<span class="st">&#39;norm&#39;</span>,</span>
<span id="cb20-89"><a href="#cb20-89" aria-hidden="true" tabindex="-1"></a>                                            <span class="st">&#39;f_d&#39;</span>)</span>
<span id="cb20-90"><a href="#cb20-90" aria-hidden="true" tabindex="-1"></a>  )  <span class="sc">%&gt;%</span></span>
<span id="cb20-91"><a href="#cb20-91" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_impl</span>(</span>
<span id="cb20-92"><a href="#cb20-92" aria-hidden="true" tabindex="-1"></a>    <span class="fu">make_impl_args_list</span>(</span>
<span id="cb20-93"><a href="#cb20-93" aria-hidden="true" tabindex="-1"></a>      <span class="at">kernel_names =</span> <span class="fu">c</span>(<span class="st">&quot;P_year&quot;</span>, <span class="st">&quot;go_discrete_year&quot;</span>, <span class="st">&quot;stay_discrete&quot;</span>, <span class="st">&quot;leave_discrete&quot;</span>),</span>
<span id="cb20-94"><a href="#cb20-94" aria-hidden="true" tabindex="-1"></a>      <span class="at">int_rule     =</span> <span class="fu">c</span>(<span class="fu">rep</span>(<span class="st">&quot;midpoint&quot;</span>, <span class="dv">4</span>)),</span>
<span id="cb20-95"><a href="#cb20-95" aria-hidden="true" tabindex="-1"></a>      <span class="at">state_start    =</span> <span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>, <span class="st">&quot;ht&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;b&quot;</span>),</span>
<span id="cb20-96"><a href="#cb20-96" aria-hidden="true" tabindex="-1"></a>      <span class="at">state_end      =</span> <span class="fu">c</span>(<span class="st">&#39;ht&#39;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&quot;b&quot;</span>, <span class="st">&#39;ht&#39;</span>)</span>
<span id="cb20-97"><a href="#cb20-97" aria-hidden="true" tabindex="-1"></a>    )</span>
<span id="cb20-98"><a href="#cb20-98" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-99"><a href="#cb20-99" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_domains</span>(</span>
<span id="cb20-100"><a href="#cb20-100" aria-hidden="true" tabindex="-1"></a>    <span class="at">ht =</span> <span class="fu">c</span>(L, U, n)</span>
<span id="cb20-101"><a href="#cb20-101" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-102"><a href="#cb20-102" aria-hidden="true" tabindex="-1"></a>  <span class="fu">define_pop_state</span>(</span>
<span id="cb20-103"><a href="#cb20-103" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_ht =</span> init_pop_vec,</span>
<span id="cb20-104"><a href="#cb20-104" aria-hidden="true" tabindex="-1"></a>      <span class="at">n_b  =</span> init_seed_bank</span>
<span id="cb20-105"><a href="#cb20-105" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">%&gt;%</span></span>
<span id="cb20-106"><a href="#cb20-106" aria-hidden="true" tabindex="-1"></a>  <span class="fu">make_ipm</span>(</span>
<span id="cb20-107"><a href="#cb20-107" aria-hidden="true" tabindex="-1"></a>    <span class="at">iterations =</span> <span class="dv">10</span>,</span>
<span id="cb20-108"><a href="#cb20-108" aria-hidden="true" tabindex="-1"></a>    <span class="at">kernel_seq =</span> <span class="fu">sample</span>(<span class="dv">1</span><span class="sc">:</span><span class="dv">5</span>, <span class="at">size =</span> <span class="dv">10</span>, <span class="at">replace =</span> <span class="cn">TRUE</span>),</span>
<span id="cb20-109"><a href="#cb20-109" aria-hidden="true" tabindex="-1"></a>    <span class="at">usr_funs =</span> <span class="fu">list</span>(<span class="at">inv_logit   =</span> inv_logit,</span>
<span id="cb20-110"><a href="#cb20-110" aria-hidden="true" tabindex="-1"></a>                    <span class="at">inv_logit_2 =</span> inv_logit_2)</span>
<span id="cb20-111"><a href="#cb20-111" aria-hidden="true" tabindex="-1"></a>  )</span></code></pre></div>
<p>Next, we call <code>make_iter_kernel()</code> using the kernel names like so:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>block_list <span class="ot">&lt;-</span> <span class="fu">make_iter_kernel</span>(general_stoch_kern_ipm,</span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>                                 <span class="at">mega_mat =</span> <span class="fu">c</span>(stay_discrete, go_discrete_year,</span>
<span id="cb21-3"><a href="#cb21-3" aria-hidden="true" tabindex="-1"></a>                                              leave_discrete, P_year))</span></code></pre></div>
<p><code>make_iter_kernel()</code> also works for simple models, but assumes that all sub-kernels are combined additively (i.e. <span class="math inline">\(K(z&#39;,z) = P(z&#39;,z) + F(&#39;z,z)\)</span>). It can handle parameter set index syntax as well, but does not require the <code>mega_mat</code> argument, and can just be called with an IPM object.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
